<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delfin - Loans & Credit Cards</title>
    <link rel="icon" href="favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .section-badge {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .loan-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .loan-card.credit-card {
            border-left: 5px solid #f59e0b;
        }

        .loan-card.loan {
            border-left: 5px solid #8B0000;
        }

        .loan-card.completed {
            border-left: 5px solid #10b981;
        }
        
        .loan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .loan-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .loan-type-badge {
            background: #f3f4f6;
            color: #666;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .loan-toggle {
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .loan-info {
            display: flex;
            gap: 30px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-bar {
            height: 100%;
            background: #8B0000;
            transition: width 0.5s ease, background 0.5s ease;
        }

        .progress-bar.credit-card {
            background: #f59e0b;
        }
        
        .progress-bar.completed {
            background: #10b981;
        }
        
        .loan-stats {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        
        .loan-stat {
            flex: 1;
        }
        
        .loan-stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .loan-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .loan-transactions {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .loan-transactions.expanded {
            display: block;
        }
        
        .transaction-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 15px;
            align-items: center;
        }
        
        .transaction-date {
            font-size: 12px;
            color: #666;
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-type {
            font-weight: 600;
            color: #333;
        }
        
        .transaction-note {
            font-size: 12px;
            color: #666;
        }
        
        .transaction-amount {
            font-size: 16px;
            font-weight: bold;
        }
        
        .amount-positive {
            color: #10b981;
        }
        
        .amount-negative {
            color: #ef4444;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            font-size: 20px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .radio-option {
            flex: 1;
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .radio-option:hover {
            border-color: #667eea;
        }
        
        .radio-option input[type="radio"] {
            width: auto;
            margin-right: 8px;
        }
        
        .radio-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .hidden {
            display: none !important;
        }
        
        .success-message {
            background: #10b981;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-message {
            background: #ef4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
    <script src="navbar.js"></script>
</head>
<body>
    <div class="container">
        <div id="successMessage" class="success-message"></div>
        <div id="errorMessage" class="error-message"></div>
        
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">üí≥ Active Credit Cards</div>
                <div class="stat-value" id="activeCreditCards">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üìã Active Loans</div>
                <div class="stat-value" id="activeLoans">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üí∞ Total Owed</div>
                <div class="stat-value" id="totalOwed">¬£0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üìä Total Interest Paid</div>
                <div class="stat-value" id="totalInterest">¬£0.00</div>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="card loading-spinner">
            <div>‚è≥ Loading loans and credit cards...</div>
        </div>
        
        <!-- Credit Cards Section -->
        <div id="creditCardsSection" class="card" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">üí≥ Credit Cards</h2>
                <div class="section-badge" id="creditCardsCount">0</div>
            </div>
            <div id="creditCardsList"></div>
        </div>
        
        <!-- Active Loans Section -->
        <div id="activeLoansSection" class="card" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">üìã Active Loans</h2>
                <div class="section-badge" id="activeLoansCount">0</div>
            </div>
            <div id="activeLoansList"></div>
        </div>

        <!-- Completed Loans Section -->
        <div id="completedLoansSection" class="card" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">‚úÖ Paid Off Loans</h2>
                <div class="section-badge" id="completedLoansCount">0</div>
            </div>
            <div id="completedLoansList"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        
        // Global variables
        let allTransfers = [];
        let loanAccounts = [];
        let creditCardAccounts = [];
        
        // Minimum unique payees threshold to classify as credit card
        const CREDIT_CARD_PAYEE_THRESHOLD = 3;
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTransactions();
            await loadLoans();
        });
        
        // Get currency symbol
        function getCurrencySymbol(currency) {
            const symbols = {
                'GBP': '¬£',
                'EUR': '‚Ç¨',
                'USD': '$',
                'JPY': '¬•',
                'CNY': '¬•',
                'CHF': 'Fr',
                'CAD': 'CA$',
                'AUD': 'A$',
                'NZD': 'NZ$',
                'INR': '‚Çπ',
                'BRL': 'R$',
                'RUB': '‚ÇΩ',
                'KRW': '‚Ç©',
                'SEK': 'kr',
                'NOK': 'kr',
                'DKK': 'kr',
                'PLN': 'z≈Ç',
                'MXN': 'MX$',
                'ARS': 'AR$',
                'CLP': 'CL$',
                'COP': 'CO$',
                'PEN': 'S/',
                'TRY': '‚Ç∫',
                'ZAR': 'R',
                'THB': '‡∏ø',
                'SGD': 'S$',
                'HKD': 'HK$',
                'MYR': 'RM'
            };
            
            return symbols[currency] || currency;
        }
        
        // Format number
        function formatNumber(num) {
            return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Load all transfers
        async function loadTransactions() {
            try {
                const response = await fetch(`${API_URL}/transactions/transfers`);
                allTransfers = await response.json();
            } catch (error) {
                console.error('Error loading transfers:', error);
            }
        }
        
        
        // Load and categorise loans/credit cards
        async function loadLoans() {
            try {
                document.getElementById('loadingSpinner').style.display = 'block';
                document.getElementById('creditCardsSection').style.display = 'none';
                document.getElementById('activeLoansSection').style.display = 'none';
                document.getElementById('completedLoansSection').style.display = 'none';
                
                const response = await fetch(`${API_URL}/accounts?include_closed=true`);
                const accounts = await response.json();
                
                // Identify potential debt accounts (loans and credit cards)
                loanAccounts = [];
                creditCardAccounts = [];
                
                // Process accounts in parallel
                const accountPromises = accounts.map(async (account) => {
                    try {
                        const accountTransResponse = await fetch(`${API_URL}/transactions?account_id=${account.id}&limit=10000`);
                        const accountTransactions = await accountTransResponse.json();
                        
                        if (accountTransactions.length === 0) return null;
                        
                        // Sort transactions chronologically
                        accountTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                        
                        // Check the first transaction - debt accounts start negative
                        const firstTransaction = accountTransactions[0];
                        const startsNegative = firstTransaction.amount < 0;
                        
                        // Only process if account started with negative balance (loan/credit card)
                        if (startsNegative) {
                            // Count unique payees (excluding transfers)
                            const transferIds = new Set();
                            allTransfers.forEach(t => {
                                if (t.transfer_out_id) transferIds.add(t.transfer_out_id);
                                if (t.transfer_in_id) transferIds.add(t.transfer_in_id);
                            });
                            
                            const uniquePayees = new Set();
                            accountTransactions.forEach(trans => {
                                if (trans.payee_id && !transferIds.has(trans.id)) {
                                    uniquePayees.add(trans.payee_id);
                                }
                            });
                            
                            // Determine if it's a credit card or loan based on unique payees
                            const isCreditCard = uniquePayees.size >= CREDIT_CARD_PAYEE_THRESHOLD;
                            
                            // Use appropriate calculation function
                            const debtData = isCreditCard 
                                ? await calculateCreditCardData(account, accountTransactions)
                                : await calculateLoanData(account, accountTransactions);
                            
                            // Add type and payee count info
                            if (isCreditCard) {
                                debtData.type = 'credit-card';
                                debtData.uniquePayees = uniquePayees.size;
                                return { type: 'credit-card', data: debtData };
                            } else {
                                debtData.type = 'loan';
                                debtData.uniquePayees = uniquePayees.size;
                                return { type: 'loan', data: debtData };
                            }
                        }
                        
                        return null;
                    } catch (error) {
                        console.error(`Error processing account ${account.name}:`, error);
                        return null;
                    }
                });
                
                // Wait for all accounts to be processed
                const results = await Promise.all(accountPromises);
                const validResults = results.filter(r => r !== null);
                
                // Separate into credit cards and loans
                creditCardAccounts = validResults.filter(r => r.type === 'credit-card').map(r => r.data);
                loanAccounts = validResults.filter(r => r.type === 'loan').map(r => r.data);
                
                document.getElementById('loadingSpinner').style.display = 'none';
                
                // Display results
                if (creditCardAccounts.length > 0) {
                    document.getElementById('creditCardsSection').style.display = 'block';
                    displayCreditCards();
                }
                
                if (loanAccounts.length > 0) {
                    displayLoans();
                }
                
                updateStatistics();
                
            } catch (error) {
                console.error('Error loading loans:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                showError('Error loading loans and credit cards');
            }
        }
        
        // Calculate loan statistics (for actual loans, not credit cards)
        async function calculateLoanData(account, transactions) {
            const sortedTransactions = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const firstTrans = sortedTransactions[0];
            const openDate = new Date(firstTrans.date);
            const borrowed = Math.abs(firstTrans.amount);
            
            let balance = 0;
            let closeDate = null;
            let repaid = 0;
            let interest = 0;
            let lenderName = 'Unknown';
            
            const transferIds = new Set();
            allTransfers.forEach(t => {
                if (t.transfer_out_id) transferIds.add(t.transfer_out_id);
                if (t.transfer_in_id) transferIds.add(t.transfer_in_id);
            });
            
            for (let i = 0; i < sortedTransactions.length; i++) {
                const trans = sortedTransactions[i];
                balance += trans.amount;
                
                if (balance >= -0.5 && closeDate === null) {
                    closeDate = new Date(trans.date);
                }
                
                if (trans.amount > 0) {
                    repaid += trans.amount;
                }
                
                // For loans: all negative transactions (except first) are interest/fees
                if (trans.amount < 0 && !transferIds.has(trans.id) && trans.id !== firstTrans.id) {
                    interest += Math.abs(trans.amount);
                    
                    if (lenderName === 'Unknown' && trans.payee_name) {
                        lenderName = trans.payee_name;
                    }
                }
            }
            
            balance = Math.round(balance * 100) / 100;
            
            const currentOwed = Math.abs(Math.min(balance, 0));
            const isCompleted = balance >= -0.5;
            
            return {
                account,
                openDate,
                closeDate,
                borrowed,
                repaid,
                interest,
                currentOwed,
                isCompleted,
                lenderName,
                transactions: sortedTransactions
            };
        }
        
        // Calculate credit card statistics (different logic than loans)
        async function calculateCreditCardData(account, transactions) {
            const sortedTransactions = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const firstTrans = sortedTransactions[0];
            const openDate = new Date(firstTrans.date);
            
            let balance = 0;
            let borrowed = 0;  // Total charges on the card
            let repaid = 0;    // Total payments made
            let interest = 0;  // Only charges with "Intereses y comisiones" category
            let cardName = account.name;
            
            const transferIds = new Set();
            allTransfers.forEach(t => {
                if (t.transfer_out_id) transferIds.add(t.transfer_out_id);
                if (t.transfer_in_id) transferIds.add(t.transfer_in_id);
            });
            
            for (let i = 0; i < sortedTransactions.length; i++) {
                const trans = sortedTransactions[i];
                balance += trans.amount;
                
                if (trans.amount > 0) {
                    // Positive = payment
                    repaid += trans.amount;
                } else if (trans.amount < 0 && !transferIds.has(trans.id)) {
                    // Negative = charge
                    const absAmount = Math.abs(trans.amount);
                    
                    // Check if it's interest/fees by category name
                    if (trans.category_name && 
                        trans.category_name.toLowerCase().includes('intereses') || 
                        trans.category_name && trans.category_name.toLowerCase().includes('comisiones')) {
                        interest += absAmount;
                    } else {
                        // Regular purchase
                        borrowed += absAmount;
                    }
                }
            }
            
            balance = Math.round(balance * 100) / 100;
            
            // For credit cards, currentOwed can be negative (means you have positive balance)
            // But we typically show debt as positive number
            const currentOwed = Math.abs(Math.min(balance, 0));
            
            // Credit cards are never "completed" - they remain active
            const isCompleted = false;
            const closeDate = null;
            
            return {
                account,
                openDate,
                closeDate,
                borrowed,
                repaid,
                interest,
                currentOwed,
                isCompleted,
                lenderName: cardName,
                transactions: sortedTransactions,
                currentBalance: balance  // Can be positive or negative
            };
        }
        
        // Display credit cards
        function displayCreditCards() {
            const list = document.getElementById('creditCardsList');
            const count = document.getElementById('creditCardsCount');
            
            if (creditCardAccounts.length === 0) {
                list.innerHTML = '<div class="empty-state">No credit cards found</div>';
                count.textContent = '0';
                return;
            }
            
            count.textContent = creditCardAccounts.length;
            list.innerHTML = creditCardAccounts.map(card => displayDebtAccount(card, 'credit-card')).join('');
        }
        
        // Display loans
        function displayLoans() {
            const activeList = document.getElementById('activeLoansList');
            const completedList = document.getElementById('completedLoansList');
            const activeCount = document.getElementById('activeLoansCount');
            const completedCount = document.getElementById('completedLoansCount');
            
            // Separate active and completed loans
            const activeLoans = loanAccounts.filter(loan => !loan.isCompleted);
            const completedLoans = loanAccounts.filter(loan => loan.isCompleted);
            
            // Display active loans
            if (activeLoans.length > 0) {
                document.getElementById('activeLoansSection').style.display = 'block';
                activeCount.textContent = activeLoans.length;
                activeList.innerHTML = activeLoans.map(loan => displayDebtAccount(loan, 'loan')).join('');
            } else {
                document.getElementById('activeLoansSection').style.display = 'none';
            }
            
            // Display completed loans
            if (completedLoans.length > 0) {
                document.getElementById('completedLoansSection').style.display = 'block';
                completedCount.textContent = completedLoans.length;
                completedList.innerHTML = completedLoans.map(loan => displayDebtAccount(loan, 'loan')).join('');
            } else {
                document.getElementById('completedLoansSection').style.display = 'none';
            }
        }
        
        // Display a debt account (loan or credit card)
        function displayDebtAccount(debtAccount, type) {
            const symbol = getCurrencySymbol(debtAccount.account.currency);
            
            // Different progress calculation for credit cards vs loans
            let progressPercent;
            if (type === 'credit-card') {
                // For credit cards: show how much of charges have been paid
                const totalCharges = debtAccount.borrowed + debtAccount.interest;
                progressPercent = totalCharges > 0 
                    ? Math.min((debtAccount.repaid / totalCharges) * 100, 100) 
                    : 0;
            } else {
                // For loans: show how much of borrowed has been repaid
                progressPercent = debtAccount.borrowed > 0 
                    ? Math.min((debtAccount.repaid / debtAccount.borrowed) * 100, 100) 
                    : 0;
            }
            
            const progressBarClass = debtAccount.isCompleted ? 'completed' : type;
            // Add 'completed' class for completed loans to show green border
            const cardClass = debtAccount.isCompleted && type === 'loan' ? 'completed' : type;
            
            const typeLabel = type === 'credit-card' ? 'üí≥ Credit Card' : 'üìã Loan';
            const typeBadge = `<span class="loan-type-badge">${debtAccount.uniquePayees} unique payees</span>`;
            
            // Different labels for credit cards vs loans
            const borrowedLabel = type === 'credit-card' ? 'Total Charges' : 'Borrowed';
            const remainingLabel = type === 'credit-card' ? 'Current Balance' : 'Remaining';
            
            // For credit cards, show if balance is positive (credit) or negative (debt)
            let remainingDisplay;
            if (type === 'credit-card' && debtAccount.currentBalance !== undefined) {
                const absBalance = Math.abs(debtAccount.currentBalance);
                if (debtAccount.currentBalance > 0) {
                    // Positive balance (credit in your favour)
                    remainingDisplay = `<div class="loan-stat-value" style="color: #10b981">+${symbol}${formatNumber(absBalance)}</div>`;
                } else if (debtAccount.currentBalance < 0) {
                    // Negative balance (you owe)
                    remainingDisplay = `<div class="loan-stat-value" style="color: #ef4444">-${symbol}${formatNumber(absBalance)}</div>`;
                } else {
                    // Zero balance
                    remainingDisplay = `<div class="loan-stat-value" style="color: #666">${symbol}0.00</div>`;
                }
            } else {
                // For loans: show remaining debt
                remainingDisplay = `<div class="loan-stat-value" style="color: ${debtAccount.isCompleted ? '#10b981' : '#ef4444'}">${symbol}${formatNumber(debtAccount.currentOwed)}</div>`;
            }
            
            return `
                <div class="loan-card ${cardClass}">
                    <div class="loan-header" onclick="toggleLoan(${debtAccount.account.id})">
                        <div>
                            <span class="loan-title">${debtAccount.account.name}</span>
                            ${type === 'credit-card' ? typeBadge : ''}
                        </div>
                        <span class="loan-toggle" id="toggle-${debtAccount.account.id}">‚ñº</span>
                    </div>
                    
                    <div class="loan-info">
                        <div>${typeLabel}</div>
                        <div>üìÖ Opened: ${debtAccount.openDate.toLocaleDateString('en-GB')}</div>
                        ${debtAccount.closeDate ? `<div>‚úÖ Closed: ${debtAccount.closeDate.toLocaleDateString('en-GB')}</div>` : '<div>‚è≥ Active</div>'}
                        <div>üè¶ ${debtAccount.lenderName}</div>
                    </div>
                    
                    <div class="progress-bar-container">
                        <div class="progress-bar ${progressBarClass}" style="width: ${progressPercent}%"></div>
                    </div>
                    
                    <div class="loan-stats">
                        <div class="loan-stat">
                            <div class="loan-stat-label">${borrowedLabel}</div>
                            <div class="loan-stat-value">${symbol}${formatNumber(debtAccount.borrowed)}</div>
                        </div>
                        <div class="loan-stat">
                            <div class="loan-stat-label">Repaid</div>
                            <div class="loan-stat-value" style="color: #10b981">${symbol}${formatNumber(debtAccount.repaid)}</div>
                        </div>
                        <div class="loan-stat">
                            <div class="loan-stat-label">Interest/Fees</div>
                            <div class="loan-stat-value" style="color: #ef4444">${symbol}${formatNumber(debtAccount.interest)}</div>
                        </div>
                        <div class="loan-stat">
                            <div class="loan-stat-label">${remainingLabel}</div>
                            ${remainingDisplay}
                        </div>
                    </div>
                    
                    <div class="loan-transactions" id="transactions-${debtAccount.account.id}">
                        ${displayLoanTransactions(debtAccount.transactions, debtAccount.account.currency)}
                    </div>
                </div>
            `;
        }
        
        // Display loan/credit card transactions
        // Display loan/credit card transactions
        function displayLoanTransactions(transactions, currency) {
            const symbol = getCurrencySymbol(currency);
            
            return transactions.map(t => {
                const date = new Date(t.date).toLocaleDateString('en-GB');
                const time = new Date(t.date).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                const amountClass = t.amount < 0 ? 'amount-negative' : 'amount-positive';
                
                let type;
                let typeIcon = '';
                
                if (t.location_name && (t.location_name === 'Transfer In' || t.location_name === 'Transfer Out')) {
                    type = 'Transfer';
                    typeIcon = 'üîÑ ';
                } else if (t.amount > 0) {
                    type = 'Payment';
                    typeIcon = 'üí∞ ';
                } else {
                    // Negative transaction - check if it's interest/fee or regular charge
                    if (t.category_name && 
                        (t.category_name.toLowerCase().includes('intereses') || 
                         t.category_name.toLowerCase().includes('comisiones'))) {
                        // It's an interest or fee
                        if (t.category_name.toLowerCase().includes('intereses')) {
                            type = 'Interest';
                            typeIcon = 'üìà ';
                        } else {
                            type = 'Fee';
                            typeIcon = 'üí∏ ';
                        }
                    } else {
                        // Regular charge/purchase
                        type = 'Charge';
                        typeIcon = 'üõí ';
                    }
                }
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-date">${date}<br>${time}</div>
                        <div class="transaction-details">
                            <div class="transaction-type">${typeIcon}${type}</div>
                            ${t.category_name ? `<div class="transaction-note">üìÇ ${t.category_name}</div>` : ''}
                            ${t.payee_name ? `<div class="transaction-note">üè™ ${t.payee_name}</div>` : ''}
                            ${t.note ? `<div class="transaction-note">üìù ${t.note}</div>` : ''}
                        </div>
                        <div class="transaction-amount ${amountClass}">
                            ${symbol}${formatNumber(Math.abs(t.amount))}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle loan/credit card transactions
        function toggleLoan(accountId) {
            const transDiv = document.getElementById(`transactions-${accountId}`);
            const toggle = document.getElementById(`toggle-${accountId}`);
            
            if (transDiv.classList.contains('expanded')) {
                transDiv.classList.remove('expanded');
                toggle.style.transform = 'rotate(0deg)';
            } else {
                transDiv.classList.add('expanded');
                toggle.style.transform = 'rotate(180deg)';
            }
        }
        
        // Update statistics
        function updateStatistics() {
            const activeCreditCards = creditCardAccounts.filter(c => !c.isCompleted).length;
            const activeLoans = loanAccounts.filter(l => !l.isCompleted).length;
            
            const totalOwed = [...creditCardAccounts, ...loanAccounts]
                .filter(d => !d.isCompleted)
                .reduce((sum, d) => sum + d.currentOwed, 0);
            
            const totalInterest = [...creditCardAccounts, ...loanAccounts]
                .reduce((sum, d) => sum + d.interest, 0);
            
            document.getElementById('activeCreditCards').textContent = activeCreditCards;
            document.getElementById('activeLoans').textContent = activeLoans;
            document.getElementById('totalOwed').textContent = '¬£' + formatNumber(totalOwed);
            document.getElementById('totalInterest').textContent = '¬£' + formatNumber(totalInterest);
        }
        
        // Create new loan (keeping original functionality)
        
        function showSuccess(message) {
            const element = document.getElementById('successMessage');
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }
        
        function showError(message) {
            const element = document.getElementById('errorMessage');
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>