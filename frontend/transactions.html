<!doctype html>
<html lang="en-GB">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Delfin ¬∑ The Dashboard</title>
    <link rel="icon" href="favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>

        :root {
            --bg: #FFF1E6; 
            --panel: #FEE5D7; 
            --card: #D4B5A0; 
            --border: #D4B5A0;
            --muted: #5F5F5F; 
            --text: #2D2D2D;
            --green: #0e9530; 
            --red: #d52811; 
            --yellow: #f5b700;
            --btn-primary: #6B4D3E;  
            --btn-hover: #5C3F32;  
            --btn-red: #D65A4A;
            --btn-yellow: #E29B38;
            --btn-green: #4FAF73;
            --page-gutter: clamp(10px, 4vw, 20px);
        }

        html { height: 100%; scrollbar-gutter: stable both-edges; }
        body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: 'IBM Plex Mono', monospace; }
        * {box-sizing: border-box; }

        header { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px; position: static; background: #FEE5D7; border-bottom: 1px solid #D4B5A0; z-index: 10; }
        h1 { font-size: 30px; margin: 0; letter-spacing: 0.2px; font-family: 'Playfair Display', serif; }
    
        /* Header toolbar controls and buttons */
        .tools { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .tools select, .tools input, .tools button, .dropdown .btn {
            background: var(--bg); color: var(--text); border: 1px solid var(--border);
            border-radius: 8px; padding: 6px 10px; font-size: 12px; cursor: pointer;
        }
        .tools button { cursor: pointer; }
        .tools .primary { background: var(--panel); border-color: var(--border); }
        .tools .danger { background: var(--panel); border-color: var(--border); }
        
        /* Filters and toolbar section */
        #filters {
            display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;
            background: var(--panel); padding: 10px; border-radius: 10px; border: 1px solid var(--border);
        }
        #filters input, #filters select, #filters button {
            padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 13px; background: #fff; color: var(--text); font-family: 'IBM Plex Sans', sans-serif;
        }
        #filters select { width: auto; min-width: 120px; max-width: 250px; flex-grow: 1; }
        #filters input[type="text"] { min-width: 150px; flex-grow: 2; }
        #filters input[type="date"] { width: auto; }
        .filter-actions { display: flex; gap: 5px; margin-left: auto; }
        
        /* Bulk edit mode controls */
        .bulk-controls { display: flex; align-items: center; gap: 5px; padding-left: 10px; border-left: 1px solid var(--border); margin-left: 5px; }
        .bulk-actions-inline { display: flex; gap: 5px; max-width: 0; overflow: hidden; opacity: 0; transition: all 0.3s ease; }
        .bulk-controls.active .bulk-actions-inline { max-width: 300px; opacity: 1; }
        .btn-bulk-main { background: var(--btn-primary) !important; color: white !important; border: none !important; }
        .btn-bulk-action { font-size: 12px; padding: 6px 10px !important; }

        .container { margin: 20px auto; max-width: 1600px; }
        .card { background: var(--bg); padding: 12px; margin: 10px; overflow: hidden; }

        /* Transaction table layout and styling */
        .transactions-wrapper { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .grid-layout { display: grid; grid-template-columns: 25px 70px 190px 200px minmax(200px, 1fr) 100px 120px 120px 50px; gap: 10px; align-items: center; }
        .transactions-list:not(.bulk-edit-mode) input[type="checkbox"] { visibility: hidden; }
        .transactions-header:not(.bulk-edit-mode) .t-cell:first-child { visibility: hidden; }

        .transactions-header {
            background: var(--panel); padding: 12px 10px; border-bottom: 2px solid var(--border);
            font-weight: 700; font-size: 15px; color: var(--text); letter-spacing: 2px; font-family: 'IBM Plex Sans', sans-serif;
            letter-spacing: 0.5px; position: sticky; top: 0; z-index: 10;
        }
        .transactions-list { max-height: 700px; overflow-y: auto; border-bottom: 0.5px solid var(--border); }
        .transaction-item { padding: 6px 10px; border-bottom: 0.5px solid var(--border); font-size: 13px; transition: background 0.1s; background: #fff3ed; min-height: 38px; }
        .transaction-item:nth-child(even) { background: #fbe7dd; }
        .transaction-item:hover { background-color: var(--bg) !important; }
        .transaction-item.selected { background-color: #e3f2fd !important; border-bottom: 1px solid #90caf9; }

        .t-cell { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .t-right { text-align: right; }
        .t-center { text-align: center; }
        .t-amount { text-align: right; }
        .balance-cell { font-size: 13px; }

        /* Date/time cell hover effects */
        .date-cell { position: relative; }
        .date-display, .time-display { transition: opacity 0.2s; }
        .time-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; pointer-events: none; }
        .transaction-item:hover .date-display { opacity: 0; }
        .transaction-item:hover .time-display { opacity: 1; }

        .account-cell { position: relative; }
        .account-display, .category-hover-display { transition: opacity 0.2s; }
        .category-hover-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; pointer-events: none; white-space: nowrap; }
        .transaction-item:hover .account-display { opacity: 0; }
        .transaction-item:hover .category-hover-display { opacity: 1; }

        .category-cell { position: relative; }
        .category-display, .location-display { transition: opacity 0.2s; }
        .location-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; pointer-events: none; white-space: nowrap; }
        .transaction-item:hover .category-display { opacity: 0; }
        .transaction-item:hover .location-display { opacity: 1; }

        .note-cell { position: relative; }
        .note-display, .rate-display { transition: opacity 0.2s; }
        .rate-display { position: absolute; top: 50%; right: 0; transform: translateY(-50%); opacity: 0; pointer-events: none; white-space: nowrap; }
        .transaction-item:hover .note-cell:has(.rate-display) .note-display { opacity: 0; }
        .transaction-item:hover .rate-display { opacity: 1; }

        .amount-cell { position: relative; }
        .amount-primary, .amount-secondary { transition: opacity 0.2s; }
        .amount-secondary { position: absolute; top: 50%; right: 0; transform: translateY(-50%); opacity: 0; pointer-events: none; }
        .transaction-item:hover .amount-primary { opacity: 0; }
        .transaction-item:hover .amount-secondary { opacity: 1; }

        .balance-cell-transfer { position: relative; }
        .balance-primary, .balance-secondary { transition: opacity 0.2s; }
        .balance-secondary { position: absolute; top: 50%; right: 0; transform: translateY(-50%); opacity: 0; pointer-events: none; }
        .transaction-item:hover .balance-primary { opacity: 0; }
        .transaction-item:hover .balance-secondary { opacity: 1; }

        .action-buttons { display: flex; gap: 1px; justify-content: flex-end; }
        .btn-xs { background: none; border: none; cursor: pointer; font-size: 16px; font-weight: 600; padding: 2px; line-height: 1; transition: transform 0.1s, opacity 0.2s; opacity: 0.7; color: var(--text); }
        .btn-xs:hover { opacity: 1; transform: scale(1.3); }
        
        .success-message { background: #10b981; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .error-message { background: #ef4444; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .amount-negative { color: var(--red); }
        .amount-positive { color: var(--green); }
        .hidden { display: none; }

        /* Modal dialog windows (updated styling) */
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(45, 45, 45, 0.4);
            backdrop-filter: blur(2px);
            align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        
        /* Secondary modals that appear on top of primary modals */
        #newCategoryModal,
        #newSubcategoryModal,
        #newLocationModal,
        #newProjectModal,
        #newAccountModal {
            z-index: 1100;
        }
        
        .modal-content {
            background-color: var(--bg);
            padding: 0;
            border-radius: 12px;
            width: 90%; max-width: 550px;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            background: var(--panel);
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h3 { margin: 0; color: var(--text); font-size: 20px; font-family: 'Playfair Display', serif; }
        .modal-close { background: none; border: none; font-size: 24px; color: var(--muted); cursor: pointer; }
        .modal-close:hover { color: var(--text); }

        .modal-body { padding: 25px; }

        /* Form input styling within modals */
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: var(--muted); font-family: 'IBM Plex Sans', sans-serif; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .modal input, .modal select, .modal textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #fff;
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .modal input:focus, .modal select:focus, .modal textarea:focus {
            outline: none; border-color: var(--text);
        }

        .modal-footer {
            display: flex; gap: 10px; margin-top: 10px;
        }
        .modal-footer button {
            flex: 1; padding: 10px; border-radius: 8px; border: none;
            font-weight: 600; cursor: pointer;
        }
        .btn-save { background: var(--text); color: white; }
        .btn-save:hover { opacity: 0.9; }
        .btn-cancel { background: transparent; border: 1px solid var(--border) !important; color: var(--muted); }
        .btn-cancel:hover { background: #fff; color: var(--text); }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Bulk edit panel at bottom of screen */
        .bulk-edit-bar {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0;
            background: var(--bg);
            padding: 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            display: none; 
            z-index: 999; 
            border-top: 2px solid var(--border);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .bulk-edit-bar.active { 
            display: block; 
            max-height: calc(100vh - 700px - 20px); /* Transaction list height + margin */
            min-height: 150px;
        }
        
        .bulk-edit-header {
            background: var(--panel);
            padding: 10px 25px;
            border-bottom: 1px solid var(--border);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            gap: 15px;
        }
        .bulk-edit-header h3 { 
            margin: 0; 
            color: var(--text); 
            font-size: 18px; 
            font-family: 'Playfair Display', serif;
            flex: 1;
        }
        .bulk-header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .bulk-edit-content {
            padding: 15px 25px;
            overflow-y: auto;
            max-height: calc(100vh - 700px - 80px); /* Deduct header and margin */
        }
        
        .bulk-form-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 12px;
            margin-bottom: 0;
        }
        
        .bulk-form-group label {
            display: block; 
            margin-bottom: 6px; 
            font-weight: 500; 
            font-size: 13px; 
            color: var(--muted); 
            font-family: 'IBM Plex Sans', sans-serif;
        }
        
        .bulk-edit-bar input, 
        .bulk-edit-bar select, 
        .bulk-edit-bar textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #fff;
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .bulk-edit-bar input:focus, 
        .bulk-edit-bar select:focus, 
        .bulk-edit-bar textarea:focus {
            outline: none; 
            border-color: var(--text);
        }
        
        .bulk-edit-bar select:disabled {
            background: var(--panel);
            color: var(--muted);
            cursor: not-allowed;
        }
        
        .bulk-actions {
            display: none; /* No longer used, buttons are in the header */
        }
        
        .bulk-header-actions button {
            padding: 8px 14px; 
            border-radius: 8px; 
            border: none;
            font-weight: 600; 
            cursor: pointer;
            font-size: 13px;
            font-family: 'IBM Plex Sans', sans-serif;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .bulk-header-actions .btn-apply {
            background: var(--green);
            color: white;
        }
        .bulk-header-actions .btn-apply:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .bulk-header-actions .btn-delete {
            background: var(--red);
            color: white;
        }
        .bulk-header-actions .btn-delete:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .bulk-close-btn {
            background: transparent; 
            border: 1px solid var(--border) !important; 
            color: var(--muted);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-family: 'IBM Plex Sans', sans-serif;
            transition: all 0.2s;
        }
        .bulk-close-btn:hover {
            background: #fff; 
            color: var(--text);
        }
        .checkbox-column { display: flex; justify-content: center; visibility: hidden; }
        .bulk-edit-mode .checkbox-column { visibility: visible; }
        .transactions-header-bulk { visibility: hidden; }
        .transactions-header.bulk-active .transactions-header-bulk { visibility: visible; }
        .transaction-item.disabled { opacity: 0.4; pointer-events: none; cursor: not-allowed; }

        /* Floating Action Button */
        .fab-container {
            position: fixed; bottom: 30px; right: 30px;
            display: flex; flex-direction: row; gap: 12px; z-index: 900;
        }
        .fab-button {
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--btn-primary);
            color: white; border: none; font-size: 28px; font-weight: 700;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s; display: flex; align-items: center; justify-content: center;
            font-family: 'IBM Plex Sans', sans-serif;
        }
        .fab-button:hover { transform: scale(1.05); background: var(--btn-hover);}

        /* Badge for base currency display */
        .badge { padding: 4px 8px; border-radius: 999px; font-size: 11px; background: var(--card); border: 1px solid var(--border); font-weight: 600; }

        /* Navigation dropdown menu */
        .dropdown { position: relative; }
        .dropdown .btn { display: flex; align-items: center; gap: 8px; }
        .dropdown .menu {
            position: absolute; top: 120%; right: 0; min-width: 200px;
            background: #fff; border: 1px solid var(--border); border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none; padding: 8px; z-index: 20;
        }
        .dropdown.open .menu { display: block; }
        #navDropdown .navItem{
            width: 100%; 
            text-align: left; 
            padding: 8px 12px; 
            background: transparent; 
            cursor: pointer; 
            border: none !important;
            border-radius: 6px;
            transition: background 0.2s;
            font-size: 14px;
            font-weight: 600;
            font-family: 'IBM Plex Sans', sans-serif; color: var(--text);
        }
        #navDropdown .navItem:hover { background: var(--bg); }

        .footer { opacity: 0.7; font-size: 12px; text-align: center; margin: 104px 0px; padding-bottom: 10px; font-family: 'Playfair Display', serif; }
    </style>
</head>
<body>
    <header>
        <h1>üê¨ Delfin ¬∑ The Transactions</h1>
        <div class="tools">
            <span class="badge" id="baseCurrency">‚Äî</span>
            <button id="btnRefresh" class="primary">üîÑ Refresh</button>
            <button id="btnUpdateRates" class="danger">üí± Update rates</button>
            <div class="dropdown" id="navDropdown">
                <button class="btn" id="navBtn" onclick="toggleNav()">üìÇ Menu ‚ñæ</button>
                <div class="menu" id="navMenu">
                    <div class="list" style="padding: 6px;">
                        <button class="navItem" onclick="location.href='index.html'">üìä Dashboard</button>
                        <button class="navItem" onclick="location.href='loans.html'">üí∞ Loans</button>
                        <button class="navItem" onclick="location.href='tools.html'">üõ†Ô∏è Tools</button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="fab-container">
            <button class="fab-button" onclick="openTransferModal()" title="Add Transfer">‚áÑ</button>
            <button class="fab-button" onclick="openTransactionModal()" title="Add Transaction">+</button>
        </div>
        <div id="successMessage" class="success-message"></div>
        <div id="errorMessage" class="error-message"></div>
        
        <div class="card">
                        
            <div id="filters">
                <input type="text" id="filterSearch" placeholder="Search note or payee...">

                <input type="date" id="filterStartDate">
                <input type="date" id="filterEndDate">

                <select id="filterAccount"><option value="">All accounts</option></select>
                <select id="filterCategory"><option value="">All categories</option></select>

                <div class="filter-actions">
                    <button onclick="applyFilters()" style="background: var(--card);">Apply</button>
                    <button onclick="clearFilters()">Clear</button>
                </div>

                <div class="bulk-controls" id="bulkControls">
                    <button class="btn-bulk-main" onclick="toggleBulkMode()">Bulk Edit</button>
                    <div class="bulk-actions-inline">
                        <button class="btn-bulk-action" onclick="selectAllVisible()" style="background: var(--btn-green); color: white; border:none;">All</button>
                        <button class="btn-bulk-action" onclick="deselectAll()" style="background: var(--btn-yellow); border:none;">None</button>
                        <button class="btn-bulk-action" onclick="toggleBulkMode()" style="background: var(--btn-red); color: white; border:none;">&times;</button>
                    </div>
                </div>
            </div>
            
            <div class="transactions-wrapper">
                <div class="transactions-header grid-layout" id="transactionsHeader">
                    <div class="t-center transactions-header-bulk"> </div>
                    <div class="t-center">Date</div>
                    <div class="t-center">Account</div>
                    <div class="t-center">Payee</div>
                    <div class="t-right">Note</div>
                    <div class="t-right">Amount</div>
                    <div class="t-right">Account Bal.</div>
                    <div class="t-right">Balance</div>
                    <div class="t-right"> </div>
                </div>

                <div class="transactions-list" id="transactionsList">
                </div>
            </div>
        </div>

        <div id="newCategoryModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>New Parent Category</h3>
                    <button class="modal-close" onclick="closeModal('newCategoryModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="newCategoryName">
                    </div>
                    <div class="modal-footer">
                        <button class="btn-save" onclick="saveNewCategory()">Save</button>
                        <button class="btn-cancel" onclick="closeModal('newCategoryModal')">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="newSubcategoryModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>New Subcategory</h3>
                    <button class="modal-close" onclick="closeModal('newSubcategoryModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="newSubcategoryName">
                    </div>
                    <div class="form-group">
                        <label>Parent</label>
                        <input id="newSubcategoryParent" readonly style="background:#f0f0f0">
                    </div>
                    <div class="modal-footer">
                        <button class="btn-save" onclick="saveNewSubcategory()">Save</button>
                        <button class="btn-cancel" onclick="closeModal('newSubcategoryModal')">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="newLocationModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>New Location</h3>
                    <button class="modal-close" onclick="closeModal('newLocationModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="newLocationName">
                    </div>
                    <div class="modal-footer">
                        <button class="btn-save" onclick="saveNewLocation()">Save</button>
                        <button class="btn-cancel" onclick="closeModal('newLocationModal')">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="newProjectModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>New Project</h3>
                    <button class="modal-close" onclick="closeModal('newProjectModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="newProjectName">
                    </div>
                    <div class="modal-footer">
                        <button class="btn-save" onclick="saveNewProject()">Save</button>
                        <button class="btn-cancel" onclick="closeModal('newProjectModal')">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="newAccountModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>New Account</h3>
                    <button class="modal-close" onclick="closeModal('newAccountModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="newAccountName">
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select id="newAccountCurrency">
                            <option value="GBP">GBP</option>
                            <option value="EUR">EUR</option>
                            <option value="USD">USD</option>
                            <option value="JPY">JPY</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-save" onclick="saveNewAccount()">Save</button>
                        <button class="btn-cancel" onclick="closeModal('newAccountModal')">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="bulkEditBar" class="bulk-edit-bar">
            <div class="bulk-edit-header">
                <h3><span id="selectedCount">0</span> <span id="selectedType">items</span> selected</h3>
                <div class="bulk-header-actions">
                    <button id="bulkApplyBtn" class="btn-apply" style="display:none;">Apply</button>
                    <button id="bulkDeleteBtn" class="btn-delete" style="display:none;">Delete</button>
                    <button onclick="cancelBulkEdit()" class="bulk-close-btn">Cancel</button>
                </div>
            </div>
            <div class="bulk-edit-content">
                <div id="transactionEditFields" style="display: none;">
                    <div class="bulk-form-grid">
                        <div class="bulk-form-group">
                            <label>Payee</label>
                            <input type="text" id="bulkPayee" list="bulkPayeeList" placeholder="Don't change">
                            <datalist id="bulkPayeeList"></datalist>
                        </div>
                        <div class="bulk-form-group">
                            <label>Account</label>
                            <select id="bulkAccount">
                                <option value="">Don't change</option>
                            </select>
                        </div>
                        <div class="bulk-form-group">
                            <label>Parent Category</label>
                            <select id="bulkParentCategory">
                                <option value="">Don't change</option>
                            </select>
                        </div>
                        <div class="bulk-form-group">
                            <label>Subcategory</label>
                            <select id="bulkCategory" disabled>
                                <option value="">Select parent first...</option>
                            </select>
                        </div>
                        <div class="bulk-form-group">
                            <label>Location</label>
                            <select id="bulkLocation">
                                <option value="">Don't change</option>
                            </select>
                        </div>
                        <div class="bulk-form-group">
                            <label>Project</label>
                            <select id="bulkProject">
                                <option value="">Don't change</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="transferEditFields" style="display: none;">
                    <div class="bulk-form-grid">
                        <div class="bulk-form-group">
                            <label>From Account</label>
                            <select id="bulkTransferFromAccount">
                                <option value="">Don't change</option>
                            </select>
                        </div>
                        <div class="bulk-form-group">
                            <label>To Account</label>
                            <select id="bulkTransferToAccount">
                                <option value="">Don't change</option>
                            </select>
                        </div>
                        <div class="bulk-form-group">
                            <label>Note</label>
                            <textarea id="bulkTransferNote" rows="2" placeholder="Don't change"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>New Transaction</h3><button class="modal-close" onclick="closeTransactionModal()">&times;</button></div>
            <div class="modal-body">
                <form id="transactionForm">
                    <div class="form-row">
                        <div class="form-group"><label>Date</label><input type="date" id="date" required></div>
                        <div class="form-group"><label>Time</label><input type="time" id="time" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Amount</label><input type="number" id="amount" step="0.01" required></div>
                        <div class="form-group">
                            <label>Payee</label>
                            <input type="text" id="payee" list="payeeList" placeholder="Who?">
                            <datalist id="payeeList"></datalist>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Parent Category</label><select id="parentCategory"><option value="">Select...</option></select></div>
                        <div class="form-group"><label>Subcategory</label><select id="category" disabled><option value="">Select parent...</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Account</label><select id="account" required><option value="">Select...</option></select></div>
                        <div class="form-group"><label>Location</label><select id="location"><option value="">Select...</option></select></div>
                    </div>
                    <div class="form-group"><label>Project</label><select id="project"><option value="">Select...</option></select></div>
                    <div class="form-group"><label>Note</label><textarea id="note" rows="2"></textarea></div>
                    
                    <div class="modal-footer">
                        <button type="submit" class="btn-save">Save Transaction</button>
                        <button type="button" class="btn-cancel" onclick="closeTransactionModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="transferModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>New Transfer</h3><button class="modal-close" onclick="closeTransferModal()">&times;</button></div>
            <div class="modal-body">
                <form id="transferForm">
                    <div class="form-row">
                        <div class="form-group"><label>Date</label><input type="date" id="transferDate" required></div>
                        <div class="form-group"><label>Time</label><input type="time" id="transferTime" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>From Account</label><select id="fromAccount" required><option value="">Select...</option></select></div>
                        <div class="form-group"><label>To Account</label><select id="toAccount" required><option value="">Select...</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Amount Sent</label><input type="number" id="fromAmount" step="0.01" required></div>
                        <div class="form-group hidden" id="toAmountGroup">
                            <label>Amount Received</label>
                            <input type="number" id="toAmount" step="0.01" placeholder="Different currency?">
                        </div>
                    </div>
                    <div class="form-group"><label>Note</label><textarea id="transferNote" rows="2"></textarea></div>
                    <div class="modal-footer">
                        <button type="submit" class="btn-save">Save Transfer</button>
                        <button type="button" class="btn-cancel" onclick="closeTransferModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="footer">¬© Royal Bank of Gonz√°lez. 2025</div>

    <script>
        const API_URL = 'http://localhost:8000';
        // --- Configuration and global state ---
        let allCategories = [], allPayees = [], allAccounts = [], allAccountsIncludingClosed = [], allLocations = [], regularTransactions = [], transferTransactions = [];
        let accountsMap = new Map(); // For O(1) account lookups
        let transactionsSkip = 0; const LIMIT = 100;
        let isLoadingTransactions = false, hasMoreTransactions = true;
        let bulkEditMode = false, selectedTransactions = [], selectedTransfers = [], currentBulkType = null;
        let activeFilters = { startDate: null, endDate: null, accountId: null, categoryId: null, searchText: null };
        let filtersActive = false;

        function parseMoneyAmount(value) {
            return Math.round(parseFloat(value) * 100) / 100;
        }

        // Navigation dropdown toggle
        function toggleNav() {
            toggleDropdown('#navDropdown');
        }

        // Helper function for dropdown toggles
        const toggleDropdown = (id, open) => {
            const el = document.querySelector(id);
            if (open === undefined) {
                el.classList.toggle('open');
            } else {
                el.classList.toggle('open', open);
            }
            const btnId = id.replace('Dropdown', 'Btn');
            const menuId = id.replace('Dropdown', 'Menu');
            document.querySelector(btnId).setAttribute('aria-expanded', el.classList.contains('open'));
            document.querySelector(menuId).setAttribute('aria-hidden', !el.classList.contains('open'));
        };

        // Navigation dropdown setup
        document.querySelector('#navBtn').onclick = (e) => {
            e.stopPropagation();
            toggleDropdown('#navDropdown');
        };

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            const navDropdown = document.querySelector('#navDropdown');
            if (!navDropdown.contains(e.target)) {
                toggleDropdown('#navDropdown', false);
            }
        });

        // --- Cache management and data refresh ---
        function cacheClearAll() {
            Object.keys(localStorage).filter(k => k.startsWith('cache_')).forEach(k => localStorage.removeItem(k));
        }
        
        document.querySelector('#btnRefresh').onclick = async () => {
            try {
                const btnRefresh = document.querySelector('#btnRefresh');
                const originalText = btnRefresh.textContent;
                btnRefresh.disabled = true;
                
                cacheClearAll();
                
                btnRefresh.textContent = '‚è≥ Recalculating balances...';
                const balanceResponse = await fetch(`${API_URL}/admin/initialise-balances`, {
                    method: 'POST'
                });
                
                if (!balanceResponse.ok) {
                    throw new Error('Failed to recalculate balances');
                }
                
                btnRefresh.textContent = '‚è≥ Refreshing display...';
                await loadRecentTransactions(true); 
                
                btnRefresh.textContent = originalText;
                btnRefresh.disabled = false;
                
                alert(`Success! Recalculated all balances.`);
            } catch (error) {
                console.error('Error during refresh:', error);
                alert('Error refreshing data: ' + error.message);
                
                const btnRefresh = document.querySelector('#btnRefresh');
                btnRefresh.textContent = 'üîÑ Refresh';
                btnRefresh.disabled = false;
            }
        };

        document.querySelector('#btnUpdateRates').onclick = async () => {
            try { 
                await fetch(`${API_URL}/exchange-rates/update`, { method: 'POST' }); 
                await loadRecentTransactions(true); 
                alert('Rates updated'); 
            } catch(e) { 
                alert('Error updating rates: ' + e.message); 
            }
        };

        // Display base currency badge
        document.querySelector('#baseCurrency').textContent = 'GBP';
        
        function getCurrencySymbol(currency) {
            const symbols = { 'GBP': '¬£', 'EUR': '‚Ç¨', 'USD': '$', 'JPY': '¬•', 'CNY': '¬•' };
            return symbols[currency] || currency;
        }

        function formatMoneyWithSymbol(amount, currency) {
            const symbol = getCurrencySymbol(currency);
            const formattedAmount = formatAmount(amount);
            // EUR goes after the number, others go before
            if (currency === 'EUR') {
                return `${formattedAmount}${symbol}`;
            }
            return `${symbol}${formattedAmount}`;
        }

        function formatAmount(amount, decimals = 2) {
            const absAmount = Math.abs(amount);
            if (absAmount >= 10000) {
                return absAmount.toLocaleString('en-GB', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            }
            return absAmount.toFixed(decimals);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([loadAccounts(), loadCategories(), loadPayees(), loadLocations(), loadProjects()]);
            await loadRecentTransactions();
            
            const transactionsList = document.getElementById('transactionsList');
            transactionsList.addEventListener('scroll', () => {
                if (transactionsList.scrollTop + transactionsList.clientHeight >= transactionsList.scrollHeight - 200) loadRecentTransactions();
            });

            const now = new Date();
            document.getElementById('date').valueAsDate = now; document.getElementById('time').value = now.toTimeString().slice(0, 5);
            document.getElementById('transferDate').valueAsDate = now; document.getElementById('transferTime').value = now.toTimeString().slice(0, 5);
            
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('parentCategory').addEventListener('change', (e) => { if (e.target.value === '__NEW__') { openModal('newCategoryModal'); e.target.value = ''; } else loadSubcategories(e.target.value); });
            document.getElementById('category').addEventListener('change', (e) => { if (e.target.value === '__NEW__') { document.getElementById('newSubcategoryParent').value = document.getElementById('parentCategory').value; openModal('newSubcategoryModal'); e.target.value = ''; } });
            document.getElementById('account').addEventListener('change', (e) => { if (e.target.value === '__NEW__') { openModal('newAccountModal'); e.target.value = ''; } });
            document.getElementById('fromAccount').addEventListener('change', (e) => { if (e.target.value === '__NEW__') { window.creatingAccountFor = 'fromAccount'; openModal('newAccountModal'); e.target.value = ''; } checkTransferCurrencies(); });
            document.getElementById('toAccount').addEventListener('change', (e) => { if (e.target.value === '__NEW__') { window.creatingAccountFor = 'toAccount'; openModal('newAccountModal'); e.target.value = ''; } checkTransferCurrencies(); });
            document.getElementById('location').addEventListener('change', (e) => { if (e.target.value === '__NEW__') { openModal('newLocationModal'); e.target.value = ''; } });
            document.getElementById('project').addEventListener('change', (e) => { if (e.target.value === '__NEW__') { openModal('newProjectModal'); e.target.value = ''; } });
            document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);
            document.getElementById('transferForm').addEventListener('submit', handleTransferSubmit);
            document.getElementById('payee').addEventListener('blur', handlePayeeBlur);
            window.addEventListener('click', (e) => { if(e.target.classList.contains('modal')) e.target.classList.remove('active'); });
        }

        // --- Data loading from API ---
        async function loadAccounts() {
            try { 
                allAccountsIncludingClosed = await (await fetch(`${API_URL}/accounts?include_closed=true`)).json();
                accountsMap.clear();
                allAccountsIncludingClosed.forEach(a => accountsMap.set(a.id, a));
                allAccounts = allAccountsIncludingClosed.filter(a => a.is_active); 
                populateAllAccountDropdowns(); 
            } catch (e) { console.error(e); }
        }
        function populateAllAccountDropdowns() {
            const createOpt = (acc) => `<option value="${acc.id}" data-currency="${acc.currency}">${acc.name} (${acc.currency})</option>`;
            const newOpt = `<option value="__NEW__" style="color:#667eea;font-weight:bold">‚ûï Add new</option>`;
            // Transaction forms
            ['account', 'fromAccount', 'toAccount'].forEach(id => document.getElementById(id).innerHTML = '<option value="">Select...</option>' + allAccounts.map(createOpt).join('') + newOpt);
            // Filters (include closed)
            const sortedAccountsForFilter = [...allAccountsIncludingClosed].sort((a, b) => a.name.localeCompare(b.name));
            document.getElementById('filterAccount').innerHTML = '<option value="">All accounts</option>' + sortedAccountsForFilter.map(a => `<option value="${a.id}">${a.name}${!a.is_active ? ' (closed)' : ''}</option>`).join('');
            // Bulk edit
            document.getElementById('bulkAccount').innerHTML = '<option value="">Don\'t change</option>' + allAccounts.map(createOpt).join('');
            document.getElementById('bulkTransferFromAccount').innerHTML = '<option value="">Don\'t change</option>' + allAccounts.map(createOpt).join('');
            document.getElementById('bulkTransferToAccount').innerHTML = '<option value="">Don\'t change</option>' + allAccounts.map(createOpt).join('');
        }

        async function loadCategories() {
            try { allCategories = await (await fetch(`${API_URL}/categories?limit=1000`)).json(); populateAllCategoryDropdowns(); } catch (e) { console.error(e); }
        }
        function populateAllCategoryDropdowns() {
            const parents = [...new Set(allCategories.map(c => c.parent || c.name))].sort();
            const opts = parents.map(p => `<option value="${p}">${p}</option>`).join('');
            // Filters
            const sortedCategoriesForFilter = [...allCategories].sort((a, b) => {
                const aName = (a.parent ? a.parent + ' > ' : '') + a.name;
                const bName = (b.parent ? b.parent + ' > ' : '') + b.name;
                return aName.localeCompare(bName);
            });
            document.getElementById('filterCategory').innerHTML = '<option value="">All categories</option>' + sortedCategoriesForFilter.map(c => `<option value="${c.id}">${c.parent ? c.parent + ' > ' : ''}${c.name}</option>`).join('');
            document.getElementById('parentCategory').innerHTML = '<option value="">Select...</option>' + opts + '<option value="__NEW__" style="color:#667eea">‚ûï Add new</option>';
            document.getElementById('bulkParentCategory').innerHTML = '<option value="">Don\'t change</option>' + opts;
            document.getElementById('bulkParentCategory').onchange = (e) => loadBulkSubcategories(e.target.value);
        }
        function loadSubcategories(parent) {
            const sub = allCategories.filter(c => c.parent === parent).sort((a,b)=>a.name.localeCompare(b.name));
            const el = document.getElementById('category');
            el.disabled = false;
            el.innerHTML = '<option value="">Select...</option>' + sub.map(c => `<option value="${c.id}">${c.name}</option>`).join('') + '<option value="__NEW__" style="color:#667eea">‚ûï Add new</option>';
        }

        async function loadPayees() {
            allPayees = await (await fetch(`${API_URL}/payees`)).json();
            ['payeeList', 'bulkPayeeList'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = allPayees.map(p => `<option value="${p.name}">`).join('');
            });
        }
        async function loadLocations() {
            allLocations = await (await fetch(`${API_URL}/locations`)).json();
            populateLocationSelect();
            document.getElementById('bulkLocation').innerHTML = '<option value="">Don\'t change</option>' + allLocations.filter(l=>!l.name.includes('Transfer')).map(l => `<option value="${l.id}">${l.name}</option>`).join('');
        }
        function populateLocationSelect() {
            const select = document.getElementById('location');
            select.innerHTML = '<option value="">Select...</option>' + allLocations.filter(l=>!l.name.includes('Transfer')).map(l => `<option value="${l.id}">${l.name}</option>`).join('') + '<option value="__NEW__" style="color:#667eea">‚ûï Add new</option>';
        }
        async function loadProjects() {
            const projs = await (await fetch(`${API_URL}/projects`)).json();
            document.getElementById('project').innerHTML = '<option value="">Select...</option>' + projs.map(p => `<option value="${p.id}">${p.name}</option>`).join('') + '<option value="__NEW__" style="color:#667eea">‚ûï Add new</option>';
            document.getElementById('bulkProject').innerHTML = '<option value="">Don\'t change</option>' + projs.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        // --- Transactions ---
        async function loadRecentTransactions(reset = false) {
            if (isLoadingTransactions || (!hasMoreTransactions && !reset)) return;
            isLoadingTransactions = true;
            if (reset) { transactionsSkip = 0; hasMoreTransactions = true; regularTransactions = []; transferTransactions = []; }
            
            try {
                const params = new URLSearchParams({ skip: transactionsSkip, limit: LIMIT });
                if (filtersActive) {
                    if (activeFilters.startDate) params.append('start_date', activeFilters.startDate);
                    if (activeFilters.endDate) params.append('end_date', activeFilters.endDate);
                    if (activeFilters.accountId) params.append('account_id', activeFilters.accountId);
                    if (activeFilters.categoryId) params.append('category_id', activeFilters.categoryId);
                    if (activeFilters.searchText) params.append('search', activeFilters.searchText);
                }

                const data = await (await fetch(`${API_URL}/transactions?${params.toString()}`)).json();
                if (data.length < LIMIT) hasMoreTransactions = false;

                const newReg = [], transfersOut = [], transfersIn = [];
                data.forEach(t => {
                    if (t.location_name === 'Transfer Out') transfersOut.push(t);
                    else if (t.location_name === 'Transfer In') transfersIn.push(t);
                    else newReg.push(t);
                });

                const paired = new Set();
                const pendingTransfers = [];
                
                transfersOut.forEach(out => {
                    const match = transfersIn.find(i => i.date === out.date && i.account_id !== out.account_id && !paired.has(i.id));
                    if (match) {
                        paired.add(out.id); paired.add(match.id);
                        transferTransactions.push({
                            transfer_out_id: out.id, transfer_in_id: match.id, date: out.date,
                            from_account_name: out.account_name, from_amount: Math.abs(out.amount), from_currency: out.currency,
                            to_account_name: match.account_name, to_amount: match.amount, to_currency: match.currency,
                            note: out.note || match.note, from_balance: out.account_balance_after, to_balance: match.account_balance_after
                        });
                    } else if (filtersActive && activeFilters.accountId) {
                        pendingTransfers.push({type: 'out', data: out});
                    } else {
                        newReg.push(out);
                    }
                });
                transfersIn.forEach(i => { 
                    if (!paired.has(i.id)) {
                        if (filtersActive && activeFilters.accountId) {
                            pendingTransfers.push({type: 'in', data: i});
                        } else {
                            newReg.push(i);
                        }
                    }
                });
                
                // Batch fetch transfer partners grouped by date
                if (pendingTransfers.length > 0) {
                    const dateGroups = new Map();
                    pendingTransfers.forEach(p => {
                        const dateKey = p.data.date.split('T')[0];
                        if (!dateGroups.has(dateKey)) dateGroups.set(dateKey, []);
                        dateGroups.get(dateKey).push(p);
                    });
                    
                    const datePromises = Array.from(dateGroups.keys()).map(async dateKey => {
                        const searchParams = new URLSearchParams({ start_date: dateKey, end_date: dateKey });
                        return { dateKey, data: await (await fetch(`${API_URL}/transactions?${searchParams.toString()}`)).json() };
                    });
                    
                    const dateResults = await Promise.all(datePromises);
                    const relatedDataByDate = new Map(dateResults.map(r => [r.dateKey, r.data]));
                    
                    for (const pending of pendingTransfers) {
                        const dateKey = pending.data.date.split('T')[0];
                        const relatedData = relatedDataByDate.get(dateKey) || [];
                        
                        let partner = null;
                        if (pending.type === 'out') {
                            partner = relatedData.find(t => 
                                t.location_name === 'Transfer In' && 
                                t.date === pending.data.date && 
                                t.account_id !== pending.data.account_id
                            );
                            if (partner) {
                                transferTransactions.push({
                                    transfer_out_id: pending.data.id, transfer_in_id: partner.id, date: pending.data.date,
                                    from_account_name: pending.data.account_name, from_amount: Math.abs(pending.data.amount), from_currency: pending.data.currency,
                                    to_account_name: partner.account_name, to_amount: partner.amount, to_currency: partner.currency,
                                    note: pending.data.note || partner.note, from_balance: pending.data.account_balance_after, to_balance: partner.account_balance_after
                                });
                            } else {
                                newReg.push(pending.data);
                            }
                        } else {
                            partner = relatedData.find(t => 
                                t.location_name === 'Transfer Out' && 
                                t.date === pending.data.date && 
                                t.account_id !== pending.data.account_id
                            );
                            if (partner) {
                                transferTransactions.push({
                                    transfer_out_id: partner.id, transfer_in_id: pending.data.id, date: pending.data.date,
                                    from_account_name: partner.account_name, from_amount: Math.abs(partner.amount), from_currency: partner.currency,
                                    to_account_name: pending.data.account_name, to_amount: pending.data.amount, to_currency: pending.data.currency,
                                    note: partner.note || pending.data.note, from_balance: partner.account_balance_after, to_balance: pending.data.account_balance_after
                                });
                            } else {
                                newReg.push(pending.data);
                            }
                        }
                    }
                }
                
                regularTransactions.push(...newReg);
                transactionsSkip += LIMIT;
                displayCombinedTransactions();
            } catch (e) { console.error(e); } finally { isLoadingTransactions = false; }
        }

        function displayCombinedTransactions() {
            const combined = [
                ...regularTransactions.map(t => ({...t, type: 'tx'})),
                ...transferTransactions.map(t => ({...t, type: 'tr'}))
            ].sort((a, b) => new Date(b.date) - new Date(a.date));

            document.getElementById('transactionsList').innerHTML = combined.map(t => 
                t.type === 'tx' ? displayRegularTransaction(t) : displayTransferItem(t)
            ).join('') || '<p style="text-align:center;padding:20px;color:#888">No transactions</p>';
        }

        // --- Display functions ---
        function displayRegularTransaction(t) {
            const dateObj = new Date(t.date);
            const dateStr = `${dateObj.getDate().toString().padStart(2,'0')}/${(dateObj.getMonth()+1).toString().padStart(2,'0')}/${dateObj.getFullYear().toString().slice(-2)}`;
            const timeStr = dateObj.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            const isSel = selectedTransactions.includes(t.id);
            
            const account = accountsMap.get(t.account_id);
            const accountCurrency = account ? account.currency : t.currency;
            
            const balanceAccountColor = t.account_balance_after >= 0 ? 'var(--green)' : 'var(--red)';
            const balanceTotalColor = t.total_balance_after >= 0 ? 'var(--green)' : 'var(--red)';
            
            return `
            <div class="transaction-item grid-layout ${isSel ? 'selected' : ''}" data-transaction-id="${t.id}" onclick="${bulkEditMode ? `toggleTransactionSelection(${t.id})` : ''}">
                <div class="checkbox-column"><input type="checkbox" ${isSel ? 'checked' : ''} onclick="event.stopPropagation(); toggleTransactionSelection(${t.id})"></div>
                <div class="t-cell t-center date-cell">
                    <span class="date-display">${dateStr}</span>
                    <span class="time-display">${timeStr}</span>
                </div>
                <div class="t-cell t-center account-cell" title="${t.account_name}">
                    <span class="account-display">${t.account_name}</span>
                    <span class="category-hover-display">üè∑Ô∏è ${t.category_name || 'Uncategorised'}</span>
                </div>
                <div class="t-cell t-center ${t.location_name ? 'category-cell' : ''}" title="${t.payee_name || ''}">
                    <span class="category-display">${t.payee_name || '<span style="color:#ccc">-</span>'}</span>
                    ${t.location_name ? `<span class="location-display">üìç ${t.location_name}</span>` : ''}
                </div>
                <div class="t-cell t-right" title="${t.note || ''}" style="color:#555">${t.note || ''}</div>
                <div class="t-cell t-amount ${t.amount < 0 ? 'amount-negative' : 'amount-positive'}">${formatMoneyWithSymbol(t.amount, t.currency)}</div>
                <div class="t-cell t-amount balance-cell" style="color: ${balanceAccountColor}">${t.account_balance_after != null ? formatMoneyWithSymbol(t.account_balance_after, accountCurrency) : ''}</div>
                <div class="t-cell t-amount balance-cell" style="color: ${balanceTotalColor}">${t.total_balance_after != null ? formatMoneyWithSymbol(t.total_balance_after, 'GBP') : ''}</div>
                <div class="action-buttons">
                    <button onclick="event.stopPropagation(); editTransaction(${t.id})" class="btn-xs">‚úé</button>
                    <button onclick="event.stopPropagation(); deleteTransaction(${t.id})" class="btn-xs">√ó</button>
                </div>
            </div>`;
        }

        function displayTransferItem(t) {
            const dateObj = new Date(t.date);
            const dateStr = `${dateObj.getDate().toString().padStart(2,'0')}/${(dateObj.getMonth()+1).toString().padStart(2,'0')}/${dateObj.getFullYear().toString().slice(-2)}`;
            const timeStr = dateObj.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            const diffCurr = t.from_currency !== t.to_currency;
            
            const fromBalanceColor = t.from_balance >= 0 ? 'var(--green)' : 'var(--red)';
            const toBalanceColor = t.to_balance >= 0 ? 'var(--green)' : 'var(--red)';
            
            let amountHtml;
            if (diffCurr) {
                amountHtml = `<span class="amount-primary" style="color:#d97706">-${formatMoneyWithSymbol(t.from_amount, t.from_currency)}</span>`;
                amountHtml += `<span class="amount-secondary" style="color:#059669">+${formatMoneyWithSymbol(t.to_amount, t.to_currency)}</span>`;
            } else {
                amountHtml = `<span style="color:#333">${formatMoneyWithSymbol(t.from_amount, t.from_currency)}</span>`;
            }
            
            const rateDisplay = diffCurr ? `<span class="rate-display">üí± 1 ${t.from_currency} = ${(t.to_amount / t.from_amount).toFixed(4)} ${t.to_currency}</span>` : '';
            const balanceHtml = `<span class="balance-primary" style="color:${fromBalanceColor}">‚Üó ${formatMoneyWithSymbol(t.from_balance, t.from_currency)}</span><span class="balance-secondary" style="color:${toBalanceColor}">‚Üò ${formatMoneyWithSymbol(t.to_balance, t.to_currency)}</span>`;

            const tid = `${t.transfer_out_id}_${t.transfer_in_id}`;
            const isSel = selectedTransfers.includes(tid);

            return `
            <div class="transaction-item grid-layout ${isSel ? 'selected' : ''}" style="background:#eaf7f3" data-transfer-id="${tid}" onclick="${bulkEditMode ? `toggleTransferSelection('${tid}')` : ''}">
                <div class="checkbox-column"><input type="checkbox" ${isSel ? 'checked' : ''} onclick="event.stopPropagation(); toggleTransferSelection('${tid}')"></div>
                <div class="t-cell t-center date-cell">
                    <span class="date-display">${dateStr}</span>
                    <span class="time-display">${timeStr}</span>
                </div>
                <div class="t-cell t-center" title="${t.from_account_name}" style="color:#d97706">‚Üó ${t.from_account_name}</div>
                <div class="t-cell t-center" title="${t.to_account_name}" style="color:#059669">‚Üò ${t.to_account_name}</div>
                <div class="t-cell t-right note-cell">
                    <span class="note-display" title="${t.note || ''}" style="color:#555;font-style:italic">${t.note || ''}</span>
                    ${rateDisplay}
                </div>
                <div class="t-cell t-amount ${diffCurr ? 'amount-cell' : ''}">${amountHtml}</div>
                <div class="t-cell t-amount balance-cell-transfer">${balanceHtml}</div>
                <div class="t-cell t-center" style="color:#ccc">-</div>
                <div class="action-buttons">
                    <button onclick="event.stopPropagation(); editTransfer(${t.transfer_out_id}, ${t.transfer_in_id})" class="btn-xs">‚úé</button>
                    <button onclick="event.stopPropagation(); deleteTransfer(${t.transfer_out_id}, ${t.transfer_in_id})" class="btn-xs">√ó</button>
                </div>
            </div>`;
        }

        // --- Business logic handlers (filters, CRUD operations, bulk actions) ---
        function applyFilters() {
            activeFilters = {
                startDate: document.getElementById('filterStartDate').value,
                endDate: document.getElementById('filterEndDate').value,
                accountId: document.getElementById('filterAccount').value,
                categoryId: document.getElementById('filterCategory').value,
                searchText: document.getElementById('filterSearch').value
            };
            filtersActive = Object.values(activeFilters).some(v => v);
            loadRecentTransactions(true);
        }
        function clearFilters() {
            ['filterStartDate','filterEndDate','filterAccount','filterCategory','filterSearch'].forEach(id=>document.getElementById(id).value='');
            activeFilters = { startDate: null }; filtersActive = false; loadRecentTransactions(true);
        }

        async function handleTransactionSubmit(e) {
            e.preventDefault();
            const isEdit = e.target.dataset.editingId;
            const payeeName = document.getElementById('payee').value.trim();
            let payeeId = null;
            if (payeeName) {
                const exist = allPayees.find(p => p.name.toLowerCase() === payeeName.toLowerCase());
                if(exist) payeeId = exist.id;
                else payeeId = (await (await fetch(`${API_URL}/payees`, { method:'POST', body:JSON.stringify({name:payeeName}), headers:{'Content-Type':'application/json'} })).json()).id;
            }
            const data = {
                date: `${document.getElementById('date').value}T${document.getElementById('time').value}:00`,
                amount: parseMoneyAmount(document.getElementById('amount').value),
                currency: document.getElementById('account').selectedOptions[0].dataset.currency,
                account_id: parseInt(document.getElementById('account').value),
                category_id: document.getElementById('category').value ? parseInt(document.getElementById('category').value) : null,
                payee_id: payeeId,
                location_id: document.getElementById('location').value ? parseInt(document.getElementById('location').value) : null,
                project_id: document.getElementById('project').value ? parseInt(document.getElementById('project').value) : null,
                note: document.getElementById('note').value
            };
            const res = await fetch(`${API_URL}/transactions${isEdit ? '/'+isEdit : ''}`, { method: isEdit?'PUT':'POST', body:JSON.stringify(data), headers:{'Content-Type':'application/json'} });
            if(res.ok) { closeTransactionModal(); loadRecentTransactions(true); loadPayees(); }
        }

        async function handleTransferSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const isEdit = form.dataset.editingOutId;
            if(isEdit) { await fetch(`${API_URL}/transactions/${form.dataset.editingOutId}`, {method:'DELETE'}); await fetch(`${API_URL}/transactions/${form.dataset.editingInId}`, {method:'DELETE'}); }
            
            const data = {
                date: `${document.getElementById('transferDate').value}T${document.getElementById('transferTime').value}:00`,
                from_account_id: parseInt(document.getElementById('fromAccount').value),
                to_account_id: parseInt(document.getElementById('toAccount').value),
                from_amount: parseMoneyAmount(document.getElementById('fromAmount').value),
                to_amount: document.getElementById('toAmount').value ? parseMoneyAmount(document.getElementById('toAmount').value) : null,
                note: document.getElementById('transferNote').value
            };
            const res = await fetch(`${API_URL}/transactions/transfers`, { method:'POST', body:JSON.stringify(data), headers:{'Content-Type':'application/json'} });
            if(res.ok) { closeTransferModal(); loadRecentTransactions(true); }
        }

        function checkTransferCurrencies() {
            const f = document.getElementById('fromAccount').selectedOptions[0], t = document.getElementById('toAccount').selectedOptions[0];
            if(f && t && f.dataset.currency !== t.dataset.currency) document.getElementById('toAmountGroup').classList.remove('hidden');
            else document.getElementById('toAmountGroup').classList.add('hidden');
        }

        async function deleteTransaction(id) { if(confirm('Delete?')) { await fetch(`${API_URL}/transactions/${id}`, {method:'DELETE'}); loadRecentTransactions(true); } }
        async function deleteTransfer(outId, inId) { if(confirm('Delete transfer?')) { await fetch(`${API_URL}/transactions/${outId}`, {method:'DELETE'}); await fetch(`${API_URL}/transactions/${inId}`, {method:'DELETE'}); loadRecentTransactions(true); } }
        
        async function editTransaction(id) {
            const t = await (await fetch(`${API_URL}/transactions/${id}`)).json();
            openTransactionModal();
            const d = new Date(t.date); document.getElementById('date').valueAsDate = d; document.getElementById('time').value = d.toTimeString().slice(0,5);
            document.getElementById('amount').value = t.amount; document.getElementById('account').value = t.account_id; document.getElementById('note').value = t.note||'';
            if(t.category_id) { 
                const c = allCategories.find(x=>x.id===t.category_id); 
                if(c?.parent) { document.getElementById('parentCategory').value = c.parent; loadSubcategories(c.parent); setTimeout(()=>document.getElementById('category').value=t.category_id, 100); }
            }
            if(t.payee_name) document.getElementById('payee').value = t.payee_name;
            if(t.location_id) document.getElementById('location').value = t.location_id;
            if(t.project_id) document.getElementById('project').value = t.project_id;
            const f = document.getElementById('transactionForm'); f.dataset.editingId = id; f.querySelector('button[type="submit"]').textContent = 'Update';
        }

        async function editTransfer(outId, inId) {
            const o = await (await fetch(`${API_URL}/transactions/${outId}`)).json();
            const i = await (await fetch(`${API_URL}/transactions/${inId}`)).json();
            openTransferModal();
            const d = new Date(o.date); document.getElementById('transferDate').valueAsDate = d; document.getElementById('transferTime').value = d.toTimeString().slice(0,5);
            document.getElementById('fromAccount').value = o.account_id; document.getElementById('toAccount').value = i.account_id;
            document.getElementById('fromAmount').value = Math.abs(o.amount); 
            if(o.currency !== i.currency) document.getElementById('toAmount').value = i.amount;
            document.getElementById('transferNote').value = o.note || ''; checkTransferCurrencies();
            const f = document.getElementById('transferForm'); f.dataset.editingOutId = outId; f.dataset.editingInId = inId; f.querySelector('button[type="submit"]').textContent = 'Update';
        }
      

        // --- Bulk edit ---

        function toggleBulkMode() {
            bulkEditMode = !bulkEditMode;
            
            document.getElementById('bulkControls').classList.toggle('active', bulkEditMode);
            document.getElementById('transactionsList').classList.toggle('bulk-edit-mode');
            
            if (!bulkEditMode) {
                cancelBulkEdit();
            }
        }

        function cancelBulkEdit() {
            bulkEditMode = false; 
            selectedTransactions = []; 
            selectedTransfers = []; 
            currentBulkType = null;
            
            document.getElementById('bulkControls').classList.remove('active');
            document.getElementById('transactionsList').classList.remove('bulk-edit-mode'); 
            document.getElementById('bulkEditBar').classList.remove('active');
            
            document.querySelectorAll('.transaction-item.selected').forEach(e => e.classList.remove('selected'));
            document.querySelectorAll('input[type=checkbox]').forEach(e => e.checked = false);
            document.querySelectorAll('.transaction-item').forEach(e => e.classList.remove('disabled'));
        }

        function toggleTransactionSelection(id) {
            if(!bulkEditMode || (currentBulkType && currentBulkType !== 'tx')) return;
            currentBulkType = 'tx';
            
            const idx = selectedTransactions.indexOf(id); 
            idx > -1 ? selectedTransactions.splice(idx,1) : selectedTransactions.push(id);
            
            updateBulkUI();
        }

        function toggleTransferSelection(id) {
            if(!bulkEditMode || (currentBulkType && currentBulkType !== 'tr')) return;
            currentBulkType = 'tr';
            
            const idx = selectedTransfers.indexOf(id); 
            idx > -1 ? selectedTransfers.splice(idx,1) : selectedTransfers.push(id);
            
            updateBulkUI();
        }

        function updateBulkUI() {
            const count = selectedTransactions.length + selectedTransfers.length;
            
            if(count === 0) { 
                currentBulkType = null; 
                document.querySelectorAll('.transaction-item').forEach(e => {
                    e.classList.remove('disabled');
                    e.classList.remove('selected');
                    const checkbox = e.querySelector('input[type="checkbox"]');
                    if(checkbox) checkbox.checked = false;
                }); 
                document.getElementById('bulkEditBar').classList.remove('active'); 
                return; 
            }
            
            document.getElementById('bulkEditBar').classList.add('active');
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('selectedType').textContent = count === 1 ? 'item' : 'items';
            
            document.getElementById('transactionEditFields').style.display = currentBulkType === 'tx' ? 'block' : 'none';
            document.getElementById('transferEditFields').style.display = currentBulkType === 'tr' ? 'block' : 'none';
            
            const applyBtn = document.getElementById('bulkApplyBtn');
            const deleteBtn = document.getElementById('bulkDeleteBtn');
            
            if(currentBulkType === 'tx') {
                applyBtn.style.display = 'block';
                applyBtn.onclick = applyBulkEdit;
                deleteBtn.style.display = 'block';
                deleteBtn.onclick = bulkDeleteTransactions;
            } else if(currentBulkType === 'tr') {
                applyBtn.style.display = 'block';
                applyBtn.onclick = applyBulkTransferEdit;
                deleteBtn.style.display = 'block';
                deleteBtn.onclick = bulkDeleteTransfers;
            }
            
            document.querySelectorAll(currentBulkType === 'tx' ? '[data-transfer-id]' : '[data-transaction-id]').forEach(e => e.classList.add('disabled'));
            
            document.querySelectorAll('.transaction-item').forEach(el => {
                const isSel = (el.dataset.transactionId && selectedTransactions.includes(parseInt(el.dataset.transactionId))) || 
                              (el.dataset.transferId && selectedTransfers.includes(el.dataset.transferId));
                el.classList.toggle('selected', isSel); 
                el.querySelector('input').checked = isSel;
            });
        }
        
        function selectAllVisible() {
            if(!bulkEditMode) return;
            
            const firstItem = document.querySelector('.transaction-item:not(.disabled)');
            if(!firstItem) return;
            
            const type = firstItem.dataset.transactionId ? 'tx' : 'tr';
            if(currentBulkType && currentBulkType !== type) return;
            
            document.querySelectorAll('.transaction-item:not(.disabled)').forEach(el => {
                if(type === 'tx') { 
                    const id = parseInt(el.dataset.transactionId);
                    if(!selectedTransactions.includes(id)) selectedTransactions.push(id); 
                } else { 
                    const id = el.dataset.transferId;
                    if(!selectedTransfers.includes(id)) selectedTransfers.push(id); 
                }
            });
            
            currentBulkType = type; 
            updateBulkUI();
        }

        function deselectAll() { 
            selectedTransactions = []; 
            selectedTransfers = []; 
            updateBulkUI(); 
        }

        // Payee autofill
        async function handlePayeeBlur() {
            const payeeName = document.getElementById('payee').value.trim();
            if (!payeeName) return;
            
            if (document.getElementById('transactionForm').dataset.editingId) return;
            
            const payee = allPayees.find(p => 
                p.name.toLowerCase() === payeeName.toLowerCase()
            );
            
            if (!payee) return;
            
            try {
                if (payee.most_common_category_id) {
                    const category = allCategories.find(c => c.id === payee.most_common_category_id);
                    if (category) {
                        const parentCategorySelect = document.getElementById('parentCategory');
                        if (!parentCategorySelect.value && category.parent) {
                            const parentOption = Array.from(parentCategorySelect.options).find(
                                opt => opt.textContent === category.parent
                            );
                            if (parentOption) {
                                parentCategorySelect.value = parentOption.value;
                                parentCategorySelect.dispatchEvent(new Event('change'));
                                
                                setTimeout(() => {
                                    const categorySelect = document.getElementById('category');
                                    if (!categorySelect.value) {
                                        categorySelect.value = payee.most_common_category_id;
                                    }
                                }, 50);
                            }
                        }
                    }
                }
                
                if (payee.most_common_location_id) {
                    const locationSelect = document.getElementById('location');
                    if (!locationSelect.value) {
                        locationSelect.value = payee.most_common_location_id;
                    }
                }
                
                if (payee.most_common_project_id) {
                    const projectSelect = document.getElementById('project');
                    if (!projectSelect.value) {
                        projectSelect.value = payee.most_common_project_id;
                    }
                }
                
            } catch (error) {
                console.error('Error auto-filling from payee:', error);
            }
        }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); document.querySelectorAll('form').forEach(f=>f.reset()); }
        function openTransactionModal() { 
            openModal('transactionModal'); 
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].substring(0,5);
            document.getElementById('date').value = dateStr;
            document.getElementById('time').value = timeStr;
        }
        function closeTransactionModal() { closeModal('transactionModal'); delete document.getElementById('transactionForm').dataset.editingId; document.getElementById('transactionForm').querySelector('button[type="submit"]').textContent='Save Transaction'; }
        function openTransferModal() { 
            openModal('transferModal'); 
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].substring(0,5);
            document.getElementById('transferDate').value = dateStr;
            document.getElementById('transferTime').value = timeStr;
        }
        function closeTransferModal() { closeModal('transferModal'); delete document.getElementById('transferForm').dataset.editingOutId; document.getElementById('transferForm').querySelector('button[type="submit"]').textContent='Save Transfer'; }
        
        async function saveNewCategory(){ /* ...implementation... */ closeModal('newCategoryModal'); loadCategories(); }
        async function saveNewSubcategory(){ /* ...implementation... */ closeModal('newSubcategoryModal'); loadCategories(); }
        async function saveNewLocation(){ const n=document.getElementById('newLocationName').value; await fetch(`${API_URL}/locations`,{method:'POST',body:JSON.stringify({name:n}),headers:{'Content-Type':'application/json'}}); closeModal('newLocationModal'); loadLocations(); }
        async function saveNewProject(){ const n=document.getElementById('newProjectName').value; await fetch(`${API_URL}/projects`,{method:'POST',body:JSON.stringify({name:n}),headers:{'Content-Type':'application/json'}}); closeModal('newProjectModal'); loadProjects(); }
        async function saveNewAccount(){ const n=document.getElementById('newAccountName').value; const c=document.getElementById('newAccountCurrency').value; await fetch(`${API_URL}/accounts`,{method:'POST',body:JSON.stringify({name:n,currency:c,type:'Regular',initial_balance:0}),headers:{'Content-Type':'application/json'}}); closeModal('newAccountModal'); loadAccounts(); }
        
        function selectAllVisible() {
            if(!bulkEditMode) return;
            const type = document.querySelector('.transaction-item:not(.disabled)').dataset.transactionId ? 'tx' : 'tr';
            if(currentBulkType && currentBulkType !== type) return;
            document.querySelectorAll('.transaction-item:not(.disabled)').forEach(el => {
                if(type === 'tx') { if(!selectedTransactions.includes(parseInt(el.dataset.transactionId))) selectedTransactions.push(parseInt(el.dataset.transactionId)); }
                else { if(!selectedTransfers.includes(el.dataset.transferId)) selectedTransfers.push(el.dataset.transferId); }
            });
            currentBulkType = type; updateBulkUI();
        }
        function loadBulkSubcategories(p){ const s = document.getElementById('bulkCategory'); s.disabled=false; s.innerHTML='<option>Don\'t change</option>'+allCategories.filter(c=>c.parent===p).map(c=>`<option value="${c.id}">${c.name}</option>`).join(''); }
        
        async function applyBulkEdit() {
            if(selectedTransactions.length === 0) return;
            
            // Get form values
            const bulkPayee = document.getElementById('bulkPayee').value.trim();
            const bulkAccountId = document.getElementById('bulkAccount').value;
            const bulkCategoryId = document.getElementById('bulkCategory').value;
            const bulkLocationId = document.getElementById('bulkLocation').value;
            const bulkProjectId = document.getElementById('bulkProject').value;
            
            if(!bulkPayee && !bulkAccountId && !bulkCategoryId && !bulkLocationId && !bulkProjectId) {
                alert('No changes selected');
                return;
            }
            
            const changes = [];
            if(bulkPayee) changes.push(`Payee: ${bulkPayee}`);
            if(bulkAccountId) {
                const account = allAccounts.find(a => a.id === parseInt(bulkAccountId));
                if(account) changes.push(`Account: ${account.name}`);
            }
            if(bulkCategoryId) {
                const category = allCategories.find(c => c.id === parseInt(bulkCategoryId));
                if(category) changes.push(`Category: ${category.parent ? category.parent + ' > ' : ''}${category.name}`);
            }
            if(bulkLocationId) {
                const location = allLocations.find(l => l.id === parseInt(bulkLocationId));
                if(location) changes.push(`Location: ${location.name}`);
            }
            if(bulkProjectId) {
                const project = allProjects.find(p => p.id === parseInt(bulkProjectId));
                if(project) changes.push(`Project: ${project.name}`);
            }
            
            const confirmMsg = `Apply these changes to ${selectedTransactions.length} transaction${selectedTransactions.length > 1 ? 's' : ''}?\n\n${changes.join('\n')}`;
            if(!confirm(confirmMsg)) return;
            
            try {
                for(const txId of selectedTransactions) {
                    const current = await (await fetch(`${API_URL}/transactions/${txId}`)).json();
                    const updates = { ...current };
                    
                    if(bulkPayee) {
                        let payeeId = null;
                        const exist = allPayees.find(p => p.name.toLowerCase() === bulkPayee.toLowerCase());
                        if(exist) {
                            payeeId = exist.id;
                        } else {
                            const newPayee = await (await fetch(`${API_URL}/payees`, { 
                                method:'POST', 
                                body:JSON.stringify({name:bulkPayee}), 
                                headers:{'Content-Type':'application/json'} 
                            })).json();
                            payeeId = newPayee.id;
                        }
                        updates.payee_id = payeeId;
                    }
                    if(bulkAccountId) {
                        updates.account_id = parseInt(bulkAccountId);
                        const account = allAccounts.find(a => a.id === parseInt(bulkAccountId));
                        if(account) updates.currency = account.currency;
                    }
                    if(bulkCategoryId) updates.category_id = parseInt(bulkCategoryId);
                    if(bulkLocationId) updates.location_id = parseInt(bulkLocationId);
                    if(bulkProjectId) updates.project_id = parseInt(bulkProjectId);
                    
                    await fetch(`${API_URL}/transactions/${txId}`, {
                        method: 'PUT',
                        body: JSON.stringify(updates),
                        headers: {'Content-Type': 'application/json'}
                    });
                }
                
                alert(`Updated ${selectedTransactions.length} transaction${selectedTransactions.length > 1 ? 's' : ''}`);
                cancelBulkEdit();
                loadRecentTransactions(true);
                loadPayees(); // Reload payees if a new one was created
            } catch(error) {
                console.error('Error applying bulk edit:', error);
                alert('Error updating transactions');
            }
        }
        async function applyBulkTransferEdit() {
            if(selectedTransfers.length === 0) return;
            
            const bulkFromAccountId = document.getElementById('bulkTransferFromAccount').value;
            const bulkToAccountId = document.getElementById('bulkTransferToAccount').value;
            const bulkNote = document.getElementById('bulkTransferNote').value.trim();
            
            if(!bulkFromAccountId && !bulkToAccountId && !bulkNote) {
                alert('No changes selected');
                return;
            }
            
            const changes = [];
            if(bulkFromAccountId) {
                const account = allAccounts.find(a => a.id === parseInt(bulkFromAccountId));
                if(account) changes.push(`From Account: ${account.name}`);
            }
            if(bulkToAccountId) {
                const account = allAccounts.find(a => a.id === parseInt(bulkToAccountId));
                if(account) changes.push(`To Account: ${account.name}`);
            }
            if(bulkNote) changes.push(`Note: ${bulkNote}`);
            
            const confirmMsg = `Apply these changes to ${selectedTransfers.length} transfer${selectedTransfers.length > 1 ? 's' : ''}?\n\n${changes.join('\n')}`;
            if(!confirm(confirmMsg)) return;
            
            try {
                for(const transferId of selectedTransfers) {
                    const [outId, inId] = transferId.split('_').map(id => parseInt(id));
                    
                    const outTx = await (await fetch(`${API_URL}/transactions/${outId}`)).json();
                    const inTx = await (await fetch(`${API_URL}/transactions/${inId}`)).json();
                    
                    const outUpdates = { ...outTx };
                    const inUpdates = { ...inTx };
                    
                    if(bulkFromAccountId) {
                        outUpdates.account_id = parseInt(bulkFromAccountId);
                        const account = allAccounts.find(a => a.id === parseInt(bulkFromAccountId));
                        if(account) outUpdates.currency = account.currency;
                    }
                    if(bulkToAccountId) {
                        inUpdates.account_id = parseInt(bulkToAccountId);
                        const account = allAccounts.find(a => a.id === parseInt(bulkToAccountId));
                        if(account) inUpdates.currency = account.currency;
                    }
                    
                    if(bulkNote) {
                        outUpdates.note = bulkNote;
                        inUpdates.note = bulkNote;
                    }
                    
                    await fetch(`${API_URL}/transactions/${outId}`, {
                        method: 'PUT',
                        body: JSON.stringify(outUpdates),
                        headers: {'Content-Type': 'application/json'}
                    });
                    await fetch(`${API_URL}/transactions/${inId}`, {
                        method: 'PUT',
                        body: JSON.stringify(inUpdates),
                        headers: {'Content-Type': 'application/json'}
                    });
                }
                
                alert(`Updated ${selectedTransfers.length} transfer${selectedTransfers.length > 1 ? 's' : ''}`);
                cancelBulkEdit();
                loadRecentTransactions(true);
            } catch(error) {
                console.error('Error applying bulk transfer edit:', error);
                alert('Error updating transfers');
            }
        }
        async function bulkDeleteTransactions() { 
            if(selectedTransactions.length === 0) return;
            
            const confirmMsg = `Are you sure you want to delete ${selectedTransactions.length} transaction${selectedTransactions.length > 1 ? 's' : ''}?\n\nThis action cannot be undone.`;
            if(!confirm(confirmMsg)) return;
            
            try {
                for(let id of selectedTransactions) {
                    await fetch(`${API_URL}/transactions/${id}`, {method:'DELETE'});
                }
                alert(`Deleted ${selectedTransactions.length} transaction${selectedTransactions.length > 1 ? 's' : ''}`);
                cancelBulkEdit(); 
                loadRecentTransactions(true);
            } catch(error) {
                console.error('Error deleting transactions:', error);
                alert('Error deleting transactions');
            }
        }
        async function bulkDeleteTransfers() { 
            if(selectedTransfers.length === 0) return;
            
            const confirmMsg = `Are you sure you want to delete ${selectedTransfers.length} transfer${selectedTransfers.length > 1 ? 's' : ''}?\n\nThis action cannot be undone.`;
            if(!confirm(confirmMsg)) return;
            
            try {
                for(let id of selectedTransfers) { 
                    const [o,i]=id.split('_'); 
                    await fetch(`${API_URL}/transactions/${o}`, {method:'DELETE'}); 
                    await fetch(`${API_URL}/transactions/${i}`, {method:'DELETE'}); 
                }
                alert(`Deleted ${selectedTransfers.length} transfer${selectedTransfers.length > 1 ? 's' : ''}`);
                cancelBulkEdit(); 
                loadRecentTransactions(true);
            } catch(error) {
                console.error('Error deleting transfers:', error);
                alert('Error deleting transfers');
            }
        }
    </script>
</body>
</html>