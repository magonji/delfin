<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delfin ¬∑ The Tools</title>
    <link rel="icon" href="favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #FFF1E6; 
            --panel: #FEE5D7; 
            --card: #D4B5A0; 
            --border: #D4B5A0;
            --muted: #5F5F5F; 
            --text: #2D2D2D;
            --btn-primary: #6B4D3E;   /* Primary button colour */
            --btn-hover: #5C3F32;     /* Hover state colour */
            --danger: #D65A4A;
            --green: #0e9530; 
            --red: #d52811; 
            --yellow: #f5b700;
        }

        html { height: 100%; scrollbar-gutter: stable both-edges; }
        body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: 'IBM Plex Mono', monospace; }
        * { box-sizing: border-box; }

        header { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px; background: var(--panel); border-bottom: 1px solid var(--border); }
        h1 { font-size: 30px; margin: 0; letter-spacing: 0.2px; font-family: 'Playfair Display', serif; }

        /* Navigation dropdown menu */
        .tools { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .dropdown { position: relative; }
        .dropdown .btn {
            background: var(--bg); color: var(--text); border: 1px solid var(--border);
            border-radius: 8px; padding: 6px 10px; font-size: 12px; cursor: pointer;
            display: flex; align-items: center; gap: 8px; font-family: 'IBM Plex Sans', sans-serif;
        }
        .dropdown.open .menu { display: block; }
        .dropdown .menu {
            position: absolute; top: 120%; right: 0; min-width: 200px;
            background: #fff; border: 1px solid var(--border); border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none; padding: 8px; z-index: 20;
        }
        .navItem { 
            width: 100%; text-align: left; padding: 8px 12px; border-radius: 6px; 
            background: transparent; border: none; cursor: pointer; font-family: 'IBM Plex Sans', sans-serif; color: var(--text);
        }
        .navItem:hover { background: var(--bg); }

        .container { margin: 20px auto; max-width: 1600px; padding: 0 20px; }
        .card { background: var(--bg); padding: 25px; border: 1px solid var(--border); border-radius: 10px; }

        /* Tools grid layout and cards */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .tool-card {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
        }
        
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(212, 181, 160, 0.3);
            background: #fbe7dd;
        }
        
        .tool-icon { font-size: 40px; margin-bottom: 15px; }
        .tool-title { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: bold; color: var(--text); margin-bottom: 10px; }
        .tool-description { font-family: 'IBM Plex Sans', sans-serif; font-size: 13px; color: var(--muted); line-height: 1.4; }

        /* Modal dialogs (centred) */
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(45, 45, 45, 0.4);
            backdrop-filter: blur(2px);
        }
        
        .modal-content {
            background-color: var(--bg);
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: slideUpCentered 0.3s ease;
        }

        .modal-header {
            background: var(--panel); padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h3 { margin: 0; color: var(--text); font-size: 20px; font-family: 'Playfair Display', serif; }
        .close-btn { background: none; border: none; font-size: 24px; color: var(--muted); cursor: pointer; }
        
        /* List items and rows */
        .item-list { padding: 20px; }
        .item-row {
            display: grid; grid-template-columns: 1fr auto; gap: 10px;
            padding: 12px 15px; background: #fff3ed; border: 0.5px solid var(--border);
            border-radius: 8px; margin-bottom: 8px; align-items: center;
            font-family: 'IBM Plex Sans', sans-serif;
        }
        .item-row:nth-child(even) { background: #fbe7dd; }
        .item-name { font-weight: 600; font-size: 14px; }

        /* Form inputs and controls */
        .form-group { margin-bottom: 18px; padding: 0 25px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: var(--muted); font-family: 'IBM Plex Sans', sans-serif; }
        input, select, textarea {
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;
            background: #fff; font-family: 'IBM Plex Sans', sans-serif; font-size: 14px;
        }
        .search-box { padding: 20px 25px 0 25px; margin-bottom: 10px; }
        
        /* Button styles with updated theme colours */
        button {
            padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border);
            font-weight: 600; cursor: pointer; font-family: 'IBM Plex Sans', sans-serif;
            transition: all 0.2s; background: var(--btn-primary); color: white;
        }
        button:hover { background: var(--btn-hover); transform: translateY(-1px); }
        
        button.secondary { background: transparent; border: 1px solid var(--border) !important; color: var(--muted); }
        button.secondary:hover { background: var(--panel); color: var(--text); }
        
        button.danger { background: var(--danger); color: white; border: none; }
        button.danger:hover { opacity: 0.9; }

        .success-message { background: var(--green); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .error-message { background: var(--red); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }

        @keyframes slideUpCentered { 
            from { transform: translate(-50%, -45%); opacity: 0; } 
            to { transform: translate(-50%, -50%); opacity: 1; } 
        }
        .footer { opacity: 0.7; font-size: 12px; text-align: center; margin: 100px 0 40px 0; font-family: 'Playfair Display', serif; }

        #transactionsTable th { padding: 10px; background: var(--panel); border: 1px solid var(--border); }
        #transactionsTable td { padding: 8px; border: 1px solid var(--border); background: #fff; }
    </style>
</head>
<body>
    <header>
        <h1>üê¨ Delfin ¬∑ The Tools</h1>
        <div class="tools">
            <div class="dropdown" id="navDropdown">
                <button class="btn" id="navBtn" onclick="toggleNav()">üìÇ Menu ‚ñæ</button>
                <div class="menu" id="navMenu">
                    <div class="list" style="padding: 6px;">
                        <button class="navItem" onclick="location.href='index.html'">üìä Dashboard</button>
                        <button class="navItem" onclick="location.href='transactions.html'">üßæ Transactions</button>
                        <button class="navItem" onclick="location.href='loans.html'">üí∞ Loans</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="successMessage" class="success-message"></div>
        <div id="errorMessage" class="error-message"></div>
        
        <div class="card">
            <div class="tools-grid">
                <div class="tool-card" onclick="openTool('categories')">
                    <div class="tool-icon">üìÅ</div>
                    <div class="tool-title">Categories</div>
                    <div class="tool-description">Manage parent categories and their sub-items.</div>
                </div>
                
                <div class="tool-card" onclick="openTool('accounts')">
                    <div class="tool-icon">üí≥</div>
                    <div class="tool-title">Accounts</div>
                    <div class="tool-description">Manage names, currencies and active status.</div>
                </div>
                
                <div class="tool-card" onclick="openTool('payees')">
                    <div class="tool-icon">üë§</div>
                    <div class="tool-title">Payees</div>
                    <div class="tool-description">Edit payee names and view statistics.</div>
                </div>
                
                <div class="tool-card" onclick="openTool('locations')">
                    <div class="tool-icon">üìç</div>
                    <div class="tool-title">Locations</div>
                    <div class="tool-description">Edit common location names.</div>
                </div>
                
                <div class="tool-card" onclick="openTool('projects')">
                    <div class="tool-icon">üìã</div>
                    <div class="tool-title">Projects</div>
                    <div class="tool-description">Manage your active projects.</div>
                </div>

                <div class="tool-card" onclick="openTool('import')">
                    <div class="tool-icon">üì•</div>
                    <div class="tool-title">Import</div>
                    <div class="tool-description">Import from CSV bank statements.</div>
                </div>

                <div class="tool-card" onclick="openTool('export')">
                    <div class="tool-icon">üì§</div>
                    <div class="tool-title">Export</div>
                    <div class="tool-description">Export your data to CSV format.</div>
                </div>
                
                <div class="tool-card" onclick="openTool('backup')">
                    <div class="tool-icon">üíæ</div>
                    <div class="tool-title">Backup</div>
                    <div class="tool-description">Download a timestamped database backup.</div>
                </div>
            </div>
        </div>
    </div>

    <div id="categoriesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Manage Categories</h3><button class="close-btn" onclick="closeModal('categoriesModal')">&times;</button></div>
            <div class="search-box"><input type="text" id="categorySearch" placeholder="Search categories..." onkeyup="filterCategories()"></div>
            <div class="item-list" id="categoriesList"></div>
        </div>
    </div>
    
    <div id="accountsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Manage Accounts</h3><button class="close-btn" onclick="closeModal('accountsModal')">&times;</button></div>
            <div class="search-box"><input type="text" id="accountSearch" placeholder="Search accounts..." onkeyup="filterAccounts()"></div>
            <div class="item-list" id="accountsList"></div>
        </div>
    </div>
    
    <div id="payeesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Manage Payees</h3><button class="close-btn" onclick="closeModal('payeesModal')">&times;</button></div>
            <div style="padding: 10px 25px;"><button onclick="updateAllPayeeStatistics(event)" style="width: 100%;">üìä Update All Payee Statistics</button></div>
            <div class="search-box"><input type="text" id="payeeSearch" placeholder="Search payees..." onkeyup="filterPayees()"></div>
            <div class="item-list" id="payeesList"></div>
        </div>
    </div>
    
    <div id="locationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Manage Locations</h3><button class="close-btn" onclick="closeModal('locationsModal')">&times;</button></div>
            <div class="search-box"><input type="text" id="locationSearch" placeholder="Search locations..." onkeyup="filterLocations()"></div>
            <div class="item-list" id="locationsList"></div>
        </div>
    </div>
    
    <div id="projectsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Manage Projects</h3><button class="close-btn" onclick="closeModal('projectsModal')">&times;</button></div>
            <div class="search-box"><input type="text" id="projectSearch" placeholder="Search projects..." onkeyup="filterProjects()"></div>
            <div class="item-list" id="projectsList"></div>
        </div>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h3 id="editModalTitle">Edit Item</h3><button class="close-btn" onclick="closeModal('editModal')">&times;</button></div>
            <div style="padding: 20px 0;">
                <div class="form-group"><label>Name</label><input type="text" id="editName"></div>
                <div class="form-group" id="editCurrencyGroup" style="display: none;">
                    <label>Currency</label>
                    <select id="editCurrency"><option value="GBP">GBP (¬£)</option><option value="EUR">EUR (‚Ç¨)</option><option value="USD">USD ($)</option></select>
                </div>
                <div class="form-group" id="editParentGroup" style="display: none;"><label>Parent Category</label><input type="text" id="editParent" readonly style="background: #f0f0f0;"></div>
                <div style="display: flex; gap: 10px; padding: 0 25px;">
                    <button onclick="saveEdit()" style="flex: 1;">Save</button>
                    <button onclick="closeModal('editModal')" class="secondary" style="flex: 1;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content" style="max-width: 95%;">
            <div class="modal-header"><h3>üì• Import Statements</h3><button class="close-btn" onclick="closeModal('importModal')">&times;</button></div>
            <div style="padding: 25px;">
                <div id="importSuccessMessage" class="success-message"></div>
                <div id="importErrorMessage" class="error-message"></div>
                <div id="uploadSection">
                    <div class="form-group" style="padding: 0; margin-bottom: 20px;"><label>Select Account</label><select id="importAccount"></select></div>
                    <div style="border: 2px dashed var(--border); border-radius: 10px; padding: 40px; text-align: center; background: #fff;">
                        <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFileUpload(event)">
                        <button onclick="document.getElementById('fileInput').click()">Choose CSV File</button>
                    </div>
                </div>
                <div id="previewSection" style="display: none;">
                    <div style="overflow-x: auto; max-height: 450px;">
                        <table id="transactionsTable" style="width: 100%; border-collapse: collapse;">
                            <thead><tr><th>Skip</th><th>Date</th><th>Description</th><th>Amount</th><th>Type</th><th>Payee</th><th>Category</th><th>Note</th></tr></thead>
                            <tbody id="transactionsTableBody"></tbody>
                        </table>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="importTransactions()" style="flex: 1;">‚úÖ Import <span id="importCount">0</span> Items</button>
                        <button onclick="cancelImport()" class="secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header"><h3>üì§ Export to CSV</h3><button class="close-btn" onclick="closeModal('exportModal')">&times;</button></div>
            <div style="padding: 20px 0;">
                <div class="form-group"><label>From Date</label><input type="date" id="exportStartDate"></div>
                <div class="form-group"><label>To Date</label><input type="date" id="exportEndDate"></div>
                <div class="form-group"><label>Account</label><select id="exportAccount"></select></div>
                <div class="form-group"><label>Format</label><select id="exportFormat"><option value="standard">Standard</option><option value="detailed">Detailed</option></select></div>
                <div style="padding: 0 25px;"><button onclick="exportToCSV()" style="width: 100%;">Download CSV</button></div>
            </div>
        </div>
    </div>

    <div id="backupModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h3>üíæ Backup Database</h3><button class="close-btn" onclick="closeModal('backupModal')">&times;</button></div>
            <div style="padding: 25px; text-align: center;">
                <div id="backupStatus" style="padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none;"></div>
                <button onclick="downloadDatabaseBackup()" style="width: 100%;">Download Backup (.db)</button>
            </div>
        </div>
    </div>

    <div class="footer">¬© Royal Bank of Gonz√°lez. 2025</div>

    <script>
        // Navigation dropdown logic
        function toggleNav() { document.querySelector('#navDropdown').classList.toggle('open'); }
        document.addEventListener('click', (e) => { if (document.querySelector('#navDropdown') && !document.querySelector('#navDropdown').contains(e.target)) document.querySelector('#navDropdown').classList.remove('open'); });

        // --- Configuration and application state ---
        const API_URL = 'http://localhost:8000';
        let allCategories = [], allAccounts = [], allPayees = [], allLocations = [], allProjects = [];
        let currentEditItem = null, currentEditType = null, parsedTransactions = [], existingTransactions = [], payeeSuggestions = {}, allAccountsForImport = [];

        async function openTool(toolName) {
            switch(toolName) {
                case 'categories': await loadCategories(); displayCategories(); document.getElementById('categoriesModal').style.display = 'block'; break;
                case 'accounts': await loadAccounts(); displayAccounts(); document.getElementById('accountsModal').style.display = 'block'; break;
                case 'payees': await loadPayees(); displayPayees(); document.getElementById('payeesModal').style.display = 'block'; break;
                case 'locations': await loadLocations(); displayLocations(); document.getElementById('locationsModal').style.display = 'block'; break;
                case 'projects': await loadProjects(); displayProjects(); document.getElementById('projectsModal').style.display = 'block'; break;
                case 'import': await loadImportData(); document.getElementById('importModal').style.display = 'block'; break;
                case 'export': await loadExportData(); document.getElementById('exportModal').style.display = 'block'; break;
                case 'backup': document.getElementById('backupModal').style.display = 'block'; break;
            }
        }

        // --- Modal management ---
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

        // --- Data loading from API ---
        async function loadCategories() { const r = await fetch(`${API_URL}/categories?limit=1000`); allCategories = await r.json(); allCategories.sort((a, b) => (a.parent || '').localeCompare(b.parent || '') || a.name.localeCompare(b.name)); }
        async function loadAccounts() { const r = await fetch(`${API_URL}/accounts/with-balances?include_closed=true`); allAccounts = await r.json(); allAccounts.sort((a, b) => (b.is_active - a.is_active) || a.name.localeCompare(b.name)); }
        async function loadPayees() { const r = await fetch(`${API_URL}/payees`); allPayees = await r.json(); allPayees.sort((a, b) => a.name.localeCompare(b.name)); }
        async function loadLocations() { const r = await fetch(`${API_URL}/locations`); allLocations = await r.json(); allLocations.sort((a, b) => a.name.localeCompare(b.name)); }
        async function loadProjects() { const r = await fetch(`${API_URL}/projects`); allProjects = await r.json(); allProjects.sort((a, b) => a.name.localeCompare(b.name)); }

        // --- Display and rendering functions ---
        function displayCategories(filtered = null) {
            const categories = filtered || allCategories;
            const list = document.getElementById('categoriesList');
            const grouped = {}; const parents = new Set();
            categories.forEach(c => { if (c.parent) { parents.add(c.parent); if (!grouped[c.parent]) grouped[c.parent] = []; grouped[c.parent].push(c); } });
            const standalone = categories.filter(c => !c.parent && !parents.has(c.name));
            standalone.forEach(c => grouped[c.name] = []);
            let html = '';
            Object.keys(grouped).sort().forEach(p => {
                const subs = (grouped[p] || []).sort((a,b)=>a.name.localeCompare(b.name));
                if (subs.length > 0) {
                    html += `<div style="margin-bottom:20px;"><div style="display:flex;justify-content:space-between;align-items:center;font-weight:bold;color:var(--text);padding:10px;background:var(--panel);border-radius:8px;"><span>üìÅ ${p}</span><button onclick="editParentCategory('${p.replace(/'/g, "\\'")}', ${JSON.stringify(subs.map(c => c.id))})" style="padding:4px 8px;font-size:11px;">Edit Parent</button></div>`;
                    subs.forEach(c => { html += `<div class="item-row" style="margin-left:20px;margin-top:5px;"><div class="item-name">‚îî‚îÄ ${c.name}</div><button onclick="editItem('category', ${c.id})" style="padding:4px 8px;font-size:11px;">Edit</button></div>`; });
                    html += '</div>';
                } else {
                    const stand = standalone.find(c => c.name === p);
                    if(stand) html += `<div class="item-row"><div class="item-name">üìÅ ${p}</div><button onclick="editItem('category', ${stand.id})" style="padding:4px 8px;font-size:11px;">Edit</button></div>`;
                }
            });
            list.innerHTML = html || '<p style="text-align:center;color:#666;">No categories found</p>';
        }

        function displayAccounts(filtered = null) {
            const list = document.getElementById('accountsList');
            list.innerHTML = (filtered || allAccounts).map(acc => `
                <div class="item-row" style="${acc.is_active === 0 ? 'opacity:0.6;' : ''}">
                    <div><div class="item-name">${acc.name} ${acc.is_active ? '<small style="color:var(--green)">(Active)</small>' : '<small style="color:var(--red)">(Closed)</small>'}</div><small>${acc.currency} | Bal: ${acc.current_balance.toFixed(2)}</small></div>
                    <div style="display:flex;gap:5px;">
                        <button onclick="editItem('account', ${acc.id})" style="padding:4px 8px;font-size:11px;">Edit</button>
                        ${acc.is_active ? `<button onclick="closeAccount(${acc.id}, '${acc.name.replace(/'/g, "\\'")}', ${acc.current_balance})" class="danger" style="padding:4px 8px;font-size:11px;">Close</button>` : `<button onclick="openAccount(${acc.id}, '${acc.name.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:11px;">Reopen</button>`}
                    </div>
                </div>`).join('');
        }

        function displayPayees(filtered = null) { document.getElementById('payeesList').innerHTML = (filtered || allPayees).map(p => `<div class="item-row"><div class="item-name">${p.name}</div><button onclick="editItem('payee', ${p.id})" style="padding:4px 8px;font-size:11px;">Edit</button></div>`).join(''); }
        function displayLocations(filtered = null) { document.getElementById('locationsList').innerHTML = (filtered || allLocations).map(l => `<div class="item-row"><div class="item-name">${l.name}</div><button onclick="editItem('location', ${l.id})" style="padding:4px 8px;font-size:11px;">Edit</button></div>`).join(''); }
        function displayProjects(filtered = null) { document.getElementById('projectsList').innerHTML = (filtered || allProjects).map(p => `<div class="item-row"><div class="item-name">${p.name}</div><button onclick="editItem('project', ${p.id})" style="padding:4px 8px;font-size:11px;">Edit</button></div>`).join(''); }

        // --- Search and filter functions ---
        function filterCategories() { const s = document.getElementById('categorySearch').value.toLowerCase(); displayCategories(allCategories.filter(c => c.name.toLowerCase().includes(s) || (c.parent && c.parent.toLowerCase().includes(s)))); }
        function filterAccounts() { const s = document.getElementById('accountSearch').value.toLowerCase(); displayAccounts(allAccounts.filter(a => a.name.toLowerCase().includes(s))); }
        function filterPayees() { const s = document.getElementById('payeeSearch').value.toLowerCase(); displayPayees(allPayees.filter(p => p.name.toLowerCase().includes(s))); }
        function filterLocations() { const s = document.getElementById('locationSearch').value.toLowerCase(); displayLocations(allLocations.filter(l => l.name.toLowerCase().includes(s))); }
        function filterProjects() { const s = document.getElementById('projectSearch').value.toLowerCase(); displayProjects(allProjects.filter(p => p.name.toLowerCase().includes(s))); }

        // --- Edit and update operations ---
        function editItem(type, id) {
            currentEditType = type; let item;
            document.getElementById('editCurrencyGroup').style.display = 'none'; document.getElementById('editParentGroup').style.display = 'none';
            if(type==='category') { item = allCategories.find(c=>c.id===id); if(item.parent){document.getElementById('editParentGroup').style.display='block';document.getElementById('editParent').value=item.parent;} }
            else if(type==='account') { item = allAccounts.find(a=>a.id===id); document.getElementById('editCurrencyGroup').style.display='block'; document.getElementById('editCurrency').value=item.currency; }
            else if(type==='payee') item = allPayees.find(p=>p.id===id);
            else if(type==='location') item = allLocations.find(l=>l.id===id);
            else if(type==='project') item = allProjects.find(p=>p.id===id);
            currentEditItem = item; document.getElementById('editName').value = item.name;
            document.getElementById('editModalTitle').textContent = `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            document.getElementById('editModal').style.display = 'block';
        }

        async function saveEdit() {
            const newName = document.getElementById('editName').value.trim(); if(!newName) return showError('Name empty');
            let body = { name: newName };
            if(currentEditType==='category') body = { name: newName, parent: currentEditItem.parent, type: currentEditItem.type };
            if(currentEditType==='account') body = { name: newName, currency: document.getElementById('editCurrency').value, type: currentEditItem.type, initial_balance: currentEditItem.initial_balance };
            const r = await fetch(`${API_URL}/${currentEditType}s/${currentEditItem.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if(r.ok) { showSuccess('Saved'); closeModal('editModal'); openTool(currentEditType + 's'); }
        }

        // --- Account management (close/reopen with validation) ---
        async function closeAccount(id, name, bal) { if(Math.abs(bal)>0.01) return showError('Non-zero balance'); if(confirm(`Close "${name}"?`)){ await fetch(`${API_URL}/accounts/${id}/close`, {method:'PATCH'}); loadAccounts(); displayAccounts(); } }
        async function openAccount(id, name) { if(confirm(`Reopen "${name}"?`)){ await fetch(`${API_URL}/accounts/${id}/open`, {method:'PATCH'}); loadAccounts(); displayAccounts(); } }
        async function editParentCategory(oldName, ids) { const newName = prompt('New parent:', oldName); if(!newName || newName.trim() === oldName) return; for(let id of ids) { const cat = allCategories.find(c => c.id === id); await fetch(`${API_URL}/categories/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: cat.name, parent: newName.trim(), type: cat.type }) }); } await loadCategories(); displayCategories(); }
        async function updateAllPayeeStatistics(e) { if(!confirm('Recalculate stats?')) return; const r = await fetch(`${API_URL}/payees/recalculate-all-stats`, { method: 'POST' }); if(r.ok) { const res = await r.json(); showSuccess(`Done`); loadPayees(); displayPayees(); } }
        
        // --- User notification messages ---
        function showSuccess(m) { const e = document.getElementById('successMessage'); e.textContent = m; e.style.display = 'block'; setTimeout(() => e.style.display = 'none', 3000); }
        function showError(m) { const e = document.getElementById('errorMessage'); e.textContent = m; e.style.display = 'block'; setTimeout(() => e.style.display = 'none', 5000); }

        // --- CSV import functionality ---
        async function loadImportData() {
            const ac = await (await fetch(`${API_URL}/accounts`)).json(); allAccountsForImport = ac;
            document.getElementById('importAccount').innerHTML = '<option value="">Select...</option>' + ac.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            allPayees = await (await fetch(`${API_URL}/payees`)).json();
            allCategories = await (await fetch(`${API_URL}/categories?limit=1000`)).json();
            existingTransactions = await (await fetch(`${API_URL}/transactions?limit=100000`)).json();
        }

        // Parse CSV file and detect duplicate transactions
        async function handleFileUpload(e) {
            const file = e.target.files[0]; const accId = document.getElementById('importAccount').value; if(!accId) return alert('Select account');
            const lines = (await file.text()).split('\n'); const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const dateIdx = headers.findIndex(h => h.toLowerCase().includes('date')), descIdx = headers.findIndex(h => h.toLowerCase().includes('desc') || h.toLowerCase().includes('name')), amountIdx = headers.findIndex(h => h.toLowerCase().includes('amount'));
            parsedTransactions = [];
            for(let i=1; i<lines.length; i++) {
                const parts = lines[i].split(',').map(p => p.trim().replace(/"/g, '')); if(parts.length < headers.length) continue;
                const amount = parseFloat(parts[amountIdx]); if(isNaN(amount)) continue;
                parsedTransactions.push({ date: new Date(parts[dateIdx]).toISOString(), description: parts[descIdx], amount, account_id: parseInt(accId) });
            }
            checkDuplicates(); displayTransactionsPreview();
            document.getElementById('uploadSection').style.display = 'none'; document.getElementById('previewSection').style.display = 'block';
        }

        function checkDuplicates() { parsedTransactions.forEach(t => t.isDuplicate = existingTransactions.some(e => e.account_id === t.account_id && e.amount === t.amount && e.date.slice(0,10) === t.date.slice(0,10))); }
        function displayTransactionsPreview() {
            document.getElementById('transactionsTableBody').innerHTML = parsedTransactions.map((t, i) => `<tr style="${t.isDuplicate ? 'background:#fee;' : ''}"><td><input type="checkbox" id="skip_${i}" ${t.isDuplicate ? 'checked' : ''}></td><td>${t.date.slice(0,10)}</td><td>${t.description}</td><td>${t.amount.toFixed(2)}</td><td>Trans</td><td>${t.description}</td><td><select id="cat_${i}">${allCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></td><td>-</td></tr>`).join('');
            document.getElementById('importCount').textContent = parsedTransactions.length - parsedTransactions.filter(t=>t.isDuplicate).length;
        }

        async function importTransactions() {
            for(let i=0; i<parsedTransactions.length; i++) {
                if(document.getElementById(`skip_${i}`).checked) continue;
                await fetch(`${API_URL}/transactions`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date: parsedTransactions[i].date, amount: parsedTransactions[i].amount, account_id: parsedTransactions[i].account_id, payee_name: parsedTransactions[i].description, category_id: parseInt(document.getElementById(`cat_${i}`).value), currency: 'GBP' }) });
            }
            showSuccess('Imported!'); closeModal('importModal');
        }

        function cancelImport() { document.getElementById('uploadSection').style.display='block'; document.getElementById('previewSection').style.display='none'; }
        
        // --- CSV export functionality ---
        async function loadExportData() { const ac = await (await fetch(`${API_URL}/accounts`)).json(); document.getElementById('exportAccount').innerHTML = '<option value="">All</option>' + ac.map(a => `<option value="${a.id}">${a.name}</option>`).join(''); }
        async function exportToCSV() {
            const accId = document.getElementById('exportAccount').value, start = document.getElementById('exportStartDate').value, end = document.getElementById('exportEndDate').value;
            let url = `${API_URL}/transactions?limit=100000`; if(accId) url += `&account_id=${accId}`; if(start) url += `&start_date=${start}`; if(end) url += `&end_date=${end}`;
            const ts = await (await fetch(url)).json(); let csv = 'Date,Description,Amount,Account,Category\n';
            ts.forEach(t => csv += `${t.date},${t.payee_name || ''},${t.amount},${t.account_name},${t.category_name || ''}\n`);
            const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); link.download = 'export.csv'; link.click();
        }

        // --- Database backup functionality ---
        async function downloadDatabaseBackup() {
            const s = document.getElementById('backupStatus'); s.style.display = 'block'; s.textContent = 'Creating...';
            const r = await fetch(`${API_URL}/admin/backup-database`, { method: 'POST' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(await r.blob()); link.download = `backup_${new Date().toISOString().slice(0,10)}.db`; link.click();
            s.textContent = 'Done!'; setTimeout(() => s.style.display = 'none', 3000);
        }
    </script>
</body>
</html>