<!doctype html>
<html lang="en-GB">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Delfin ¬∑ The Budget</title>
    <link rel="icon" href="favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #FFF1E6; --panel: #FEE5D7; --card: #D4B5A0; --border: #D4B5A0;
            --muted: #5F5F5F; --text: #2D2D2D;
            --green: #0e9530; --red: #d52811; --yellow: #f5b700;
            --page-gutter: clamp(10px, 4vw, 20px);
        }

        * { box-sizing: border-box; }
        html { height: 100%; scrollbar-gutter: stable both-edges; }
        body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: 'IBM Plex Mono', monospace; }

        /* Header */
        header { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px; backdrop-filter: blur(8px); background: #FEE5D7; border-bottom: 1px solid #D4B5A0; z-index: 10; }
        h1 { font-size: 30px; margin: 0; letter-spacing: 0.2px; font-family: 'Playfair Display', serif; }

        /* Toolbar */
        .tools { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .tools select, .tools input, .tools button, .dropdown .btn {
            background: var(--bg); color: var(--text); border: 1px solid var(--border);
            border-radius: 8px; padding: 6px 10px; font-size: 12px; cursor: pointer;
        }
        .tools .primary { background: var(--panel); border-color: var(--border); }

        /* Card component */
        .card { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 16px; }
        .card .head { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid var(--border); background: var(--bg); }
        .card .title { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 2px; font-family: 'IBM Plex Sans', sans-serif; text-transform: uppercase; }
        .card .content { padding: 12px 14px; }

        /* Layout */
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

        /* Budget card */
        .budget-amount { font-size: 32px; font-weight: 700; margin: 10px 0; }
        .budget-amount .edit-btn { font-size: 14px; margin-left: 10px; cursor: pointer; opacity: 0.6; }
        .budget-amount .edit-btn:hover { opacity: 1; }

        /* Progress bar */
        .progress-container { margin: 20px 0; }
        .progress-bar { height: 24px; background: var(--panel); border-radius: 12px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; border-radius: 12px; transition: width 0.5s ease; }
        .progress-fill.green { background: var(--green); }
        .progress-fill.yellow { background: var(--yellow); }
        .progress-fill.red { background: var(--red); }
        .progress-label { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-weight: 700; font-size: 14px; }

        /* Stats row */
        .stats-row { display: flex; justify-content: space-between; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
        .stat { text-align: center; flex: 1; min-width: 100px; }
        .stat-label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 22px; font-weight: 700; margin-top: 4px; }
        .stat-value.spent { color: var(--red); }
        .stat-value.committed { color: var(--yellow); }
        .stat-value.available { color: var(--green); }

        .days-info { text-align: center; padding: 10px; background: var(--panel); border-radius: 8px; margin-top: 10px; }

        .income-info { padding: 12px; background: var(--panel); border-radius: 8px; margin-top: 10px; }
        .income-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
        .income-row .label { color: var(--muted); font-size: 13px; }
        .income-row .value { font-weight: 700; font-variant-numeric: tabular-nums; }
        .income-row .value.positive { color: var(--green); }
        .income-row .value.negative { color: var(--red); }

        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; vertical-align: middle; margin-left: 8px; }
        .badge.future { background: #6366f1; color: white; }

        /* Recurring list */
        .recurring-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }
        .recurring-item:hover { background: var(--panel); }
        .recurring-item .status { width: 24px; font-size: 16px; }
        .recurring-item .info { flex: 1; margin-left: 10px; }
        .recurring-item .name { font-weight: 600; }
        .recurring-item .category { font-size: 12px; color: var(--muted); }
        .recurring-item .amount { font-weight: 700; font-variant-numeric: tabular-nums; }
        .recurring-item.paid { opacity: 0.6; }
        .recurring-item.paid .amount { color: var(--muted); text-decoration: line-through; }
        .recurring-item.not-applicable { opacity: 0.5; background: transparent; }
        .recurring-item.not-applicable .amount { color: var(--muted); }

        .recurring-summary { display: flex; justify-content: space-between; padding: 10px; background: var(--panel); border-radius: 8px; margin-top: 10px; font-size: 13px; }

        /* Category spending */
        .category-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--panel); }
        .category-item:last-child { border-bottom: none; }
        .category-item .name { flex: 1; font-weight: 500; }
        .category-item .bar-container { width: 100px; height: 8px; background: var(--panel); border-radius: 4px; overflow: hidden; }
        .category-item .bar { height: 100%; background: var(--red); border-radius: 4px; }
        .category-item .amount { min-width: 80px; text-align: right; font-weight: 600; font-variant-numeric: tabular-nums; }

        /* History */
        .history-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; }
        .history-item .month { font-weight: 600; }
        .history-item .budget { color: var(--muted); font-size: 13px; }
        .history-item .bar-container { flex: 1; max-width: 150px; height: 8px; background: var(--panel); border-radius: 4px; overflow: hidden; margin: 0 15px; }
        .history-item .bar { height: 100%; border-radius: 4px; }
        .history-item .percent { min-width: 60px; text-align: right; font-weight: 700; }
        .history-item .percent.over { color: var(--red); }

        /* Dropdown */
        .dropdown { position: relative; }
        .dropdown .btn { display: flex; align-items: center; gap: 8px; }
        .dropdown .menu { position: absolute; top: calc(100% + 6px); right: 0; min-width: 180px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); display: none; padding: 8px; z-index: 20; }
        .dropdown.open .menu { display: block; }
        #navDropdown .navItem { width: 100%; text-align: left; padding: 8px 12px; background: transparent; cursor: pointer; border: none !important; border-radius: 6px; transition: background 0.2s; font-size: 14px; font-weight: 600; font-family: 'IBM Plex Sans', sans-serif; color: var(--text); }
        #navDropdown .navItem:hover { background: var(--panel); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(45, 45, 45, 0.4); backdrop-filter: blur(2px); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--bg); padding: 0; border-radius: 12px; width: 90%; max-width: 450px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 1px solid var(--border); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 14px; border-bottom: 1px solid var(--border); }
        .modal-header h3 { margin: 0; font-family: 'IBM Plex Sans', sans-serif; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
        .modal-body { padding: 14px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 8px; padding: 14px; border-top: 1px solid var(--border); }

        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 13px; }
        .form-group input, .form-group select { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg); }

        .btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--green); color: white; border-color: var(--green); }
        .btn-danger { background: var(--red); color: white; border-color: var(--red); }
        .btn-secondary { background: var(--panel); }

        /* Candidates list */
        .candidate-item { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; }
        .candidate-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--green); }
        .candidate-item .info { flex: 1; }
        .candidate-item .payee { font-weight: 600; }
        .candidate-item .details { font-size: 12px; color: var(--muted); }
        .candidate-item .amount { font-weight: 700; }

        .empty-state { text-align: center; padding: 30px; color: var(--muted); }

        .muted { color: var(--muted); }
        .footer { opacity: 0.7; font-size: 12px; text-align: center; margin: 24px 10px; padding-bottom: 10px; font-family: 'Playfair Display', serif; }
    </style>
</head>
<body>
    <header>
        <h1>üê¨ Delfin ¬∑ The Budget</h1>
        <div class="tools">
            <div class="dropdown" id="navDropdown">
                <button class="btn" id="navBtn" onclick="toggleNav()">üìÇ Menu ‚ñæ</button>
                <div class="menu" id="navMenu">
                    <div class="list" style="padding: 6px;">
                        <button class="navItem" onclick="location.href='index.html'">üìä Dashboard</button>
                        <button class="navItem" onclick="location.href='transactions.html'">üìë Transactions</button>
                        <button class="navItem" onclick="location.href='loans.html'">üí∞ Loans</button>
                        <button class="navItem" onclick="location.href='tools.html'">üõ†Ô∏è Tools</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Main Budget Card -->
        <div class="card">
            <div class="head">
                <h2 class="title">Monthly Budget <span id="futureBadge" class="badge future" style="display: none;">Future</span></h2>
                <div class="tools">
                    <button id="btnPrevMonth">‚óÄ</button>
                    <select id="selectMonth"></select>
                    <button id="btnNextMonth">‚ñ∂</button>
                </div>
            </div>
            <div class="content">
                <div class="budget-amount">
                    <span id="budgetDisplay">No budget set</span>
                    <span class="edit-btn" onclick="openBudgetModal()">‚úé Edit</span>
                </div>

                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill green" id="progressFill" style="width: 0%"></div>
                        <span class="progress-label" id="progressLabel">0%</span>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="stat">
                        <div class="stat-label">Spent</div>
                        <div class="stat-value spent" id="statSpent">-</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Committed</div>
                        <div class="stat-value committed" id="statCommitted">-</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Available</div>
                        <div class="stat-value available" id="statAvailable">-</div>
                    </div>
                </div>

                <div class="days-info" id="daysInfo">
                    Loading...
                </div>

                <div class="income-info" id="incomeInfo" style="display: none;">
                    <div class="income-row">
                        <span class="label">Income this month:</span>
                        <span class="value" id="incomeValue">-</span>
                    </div>
                    <div class="income-row">
                        <span class="label">Savings (Income - Spent):</span>
                        <span class="value" id="savingsValue">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid-2">
            <!-- Recurring Expenses Card -->
            <div class="card">
                <div class="head">
                    <h2 class="title">Recurring Expenses</h2>
                    <div class="tools">
                        <button class="primary" onclick="openRecurringModal()">+ Add</button>
                    </div>
                </div>
                <div class="content">
                    <div id="recurringList"></div>
                    <div class="recurring-summary" id="recurringSummary" style="display: none;">
                        <span>Total: <strong id="recurringTotal">-</strong></span>
                        <span>Paid: <strong id="recurringPaid">-</strong></span>
                        <span>Pending: <strong id="recurringPending">-</strong></span>
                    </div>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="openDetectModal()">üîç Detect from history</button>
                </div>
            </div>

            <!-- Spending by Category Card -->
            <div class="card">
                <div class="head">
                    <h2 class="title">Spending by Category</h2>
                </div>
                <div class="content">
                    <div id="categoryList"></div>
                </div>
            </div>
        </div>

        <div class="grid-2">
            <!-- Planned Expenses Card (one-time this month) -->
            <div class="card">
                <div class="head">
                    <h2 class="title">Planned This Month</h2>
                    <div class="tools">
                        <button class="primary" onclick="openPlannedModal()">+ Add</button>
                    </div>
                </div>
                <div class="content">
                    <div id="plannedList"></div>
                    <div class="recurring-summary" id="plannedSummary" style="display: none;">
                        <span>Total: <strong id="plannedTotal">-</strong></span>
                        <span>Paid: <strong id="plannedPaid">-</strong></span>
                        <span>Pending: <strong id="plannedPending">-</strong></span>
                    </div>
                </div>
            </div>

            <!-- Budget History Card -->
            <div class="card">
                <div class="head">
                    <h2 class="title">Budget History</h2>
                </div>
                <div class="content">
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">Delfin ¬∑ Budget Tracker</div>

    <!-- Budget Edit Modal -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Set Budget</h3>
                <button class="modal-close" onclick="closeModal('budgetModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Monthly Budget Amount</label>
                    <input type="number" id="budgetAmount" step="0.01" min="0" placeholder="e.g., 2000">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('budgetModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveBudget()">Save</button>
            </div>
        </div>
    </div>

    <!-- Recurring Expense Modal -->
    <div id="recurringModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="recurringModalTitle">Add Recurring Expense</h3>
                <button class="modal-close" onclick="closeModal('recurringModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="recurringId">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="recurringName" placeholder="e.g., Netflix, Rent">
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="recurringAmount" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Payee (optional)</label>
                    <select id="recurringPayee">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Category (optional)</label>
                    <select id="recurringCategory">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Day of Month (optional)</label>
                    <input type="number" id="recurringDay" min="1" max="31" placeholder="e.g., 15">
                </div>
                <div class="form-group">
                    <label>Frequency</label>
                    <select id="recurringFrequency" onchange="toggleStartMonth()">
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="biannual">Biannual (every 6 months)</option>
                        <option value="annual">Annual</option>
                    </select>
                </div>
                <div class="form-group" id="startMonthGroup" style="display: none;">
                    <label>Start Month (when first charged)</label>
                    <select id="recurringStartMonth">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteRecurringBtn" onclick="deleteRecurring()" style="display: none;">Delete</button>
                <button class="btn btn-secondary" onclick="closeModal('recurringModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveRecurring()">Save</button>
            </div>
        </div>
    </div>

    <!-- Planned Expense Modal -->
    <div id="plannedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="plannedModalTitle">Add Planned Expense</h3>
                <button class="modal-close" onclick="closeModal('plannedModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="plannedId">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="plannedName" placeholder="e.g., Dentist, Car repair">
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="plannedAmount" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Category (optional)</label>
                    <select id="plannedCategory">
                        <option value="">-- Select --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="deletePlannedBtn" onclick="deletePlanned()" style="display: none;">Delete</button>
                <button class="btn btn-secondary" onclick="closeModal('plannedModal')">Cancel</button>
                <button class="btn btn-primary" onclick="savePlanned()">Save</button>
            </div>
        </div>
    </div>

    <!-- Detect Candidates Modal -->
    <div id="detectModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h3>Detected Recurring Expenses</h3>
                <button class="modal-close" onclick="closeModal('detectModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p class="muted" style="margin-top: 0;">Select expenses to add to your recurring list:</p>
                <div id="candidatesList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('detectModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addSelectedCandidates()">Add Selected</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = (localStorage.getItem('delfin_api') || 'http://localhost:8000').replace(/\/$/, '');

        let state = {
            currentMonth: new Date().toISOString().slice(0, 7),
            availableMonths: [],
            baseCurrency: 'GBP',
            payees: [],
            categories: [],
            progress: null
        };

        // Helpers
        const q = (sel) => document.querySelector(sel);
        const qa = (sel) => Array.from(document.querySelectorAll(sel));

        const fmtMoney = (n, c = 'GBP') => new Intl.NumberFormat('en-GB', {
            style: 'currency', currency: c, maximumFractionDigits: 2
        }).format(n || 0);

        async function api(path, opts = {}) {
            const res = await fetch(`${API_BASE}${path}`, { headers: { 'Content-Type': 'application/json' }, ...opts });
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            return res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text();
        }

        // Navigation
        function toggleNav() { q('#navDropdown').classList.toggle('open'); }
        document.addEventListener('click', (e) => {
            if (!q('#navDropdown').contains(e.target)) q('#navDropdown').classList.remove('open');
        });

        // Modals
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // Initialize
        async function init() {
            try {
                // Load payees and categories for dropdowns
                [state.payees, state.categories] = await Promise.all([
                    api('/payees'),
                    api('/categories')
                ]);

                // Populate dropdowns
                populatePayeeDropdown();
                populateCategoryDropdown();

                // Load available months (extract just the value strings from objects)
                const months = await api('/dashboard/available-months');
                state.availableMonths = (months.months || []).map(m => typeof m === 'string' ? m : m.value);
                populateMonthSelector();

                // Load current month data
                await loadBudgetProgress();
                await loadBudgetHistory();
            } catch (e) {
                console.error('Init error:', e);
            }
        }

        function populateMonthSelector() {
            const select = q('#selectMonth');

            // Ensure current month is in the list
            if (!state.availableMonths.includes(state.currentMonth)) {
                state.availableMonths.unshift(state.currentMonth);
            }

            // Add future months (12 months ahead)
            const today = new Date();
            for (let i = 1; i <= 12; i++) {
                const futureDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
                const futureMonth = futureDate.toISOString().slice(0, 7);
                if (!state.availableMonths.includes(futureMonth)) {
                    state.availableMonths.push(futureMonth);
                }
            }

            // Sort descending
            state.availableMonths.sort((a, b) => b.localeCompare(a));

            const todayMonth = new Date().toISOString().slice(0, 7);
            select.innerHTML = state.availableMonths.map(m => {
                const [y, mo] = m.split('-');
                const label = new Date(y, mo - 1).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                const isFuture = m > todayMonth ? ' ‚óã' : '';
                return `<option value="${m}" ${m === state.currentMonth ? 'selected' : ''}>${label}${isFuture}</option>`;
            }).join('');
        }

        function populatePayeeDropdown() {
            const select = q('#recurringPayee');
            const sorted = [...state.payees].sort((a, b) => a.name.localeCompare(b.name));
            select.innerHTML = '<option value="">-- Select --</option>' +
                sorted.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        function populateCategoryDropdown() {
            const select = q('#recurringCategory');
            const sorted = [...state.categories].sort((a, b) => {
                const aLabel = (a.parent ? a.parent + ' > ' : '') + a.name;
                const bLabel = (b.parent ? b.parent + ' > ' : '') + b.name;
                return aLabel.localeCompare(bLabel);
            });
            select.innerHTML = '<option value="">-- Select --</option>' +
                sorted.map(c => `<option value="${c.id}">${c.parent ? c.parent + ' > ' : ''}${c.name}</option>`).join('');
        }

        async function loadBudgetProgress() {
            try {
                const data = await api(`/budgets/${state.currentMonth}/progress`);
                state.progress = data;
                state.baseCurrency = data.base_currency || 'GBP';
                renderBudgetProgress(data);
                renderRecurringList(data.recurring_expenses);
                renderPlannedList(data.planned_expenses);
                renderCategoryList(data.categories);
            } catch (e) {
                console.error('Error loading progress:', e);
                // Show empty state
                q('#budgetDisplay').textContent = 'No budget set';
                q('#progressFill').style.width = '0%';
                q('#progressLabel').textContent = '0%';
                q('#statSpent').textContent = '-';
                q('#statCommitted').textContent = '-';
                q('#statAvailable').textContent = '-';
                q('#daysInfo').textContent = 'Set a budget to track your spending';
                q('#recurringList').innerHTML = '<div class="empty-state">No recurring expenses</div>';
                q('#plannedList').innerHTML = '<div class="empty-state">No planned expenses</div>';
                q('#categoryList').innerHTML = '<div class="empty-state">No spending data</div>';
            }
        }

        function renderBudgetProgress(data) {
            const { budget, spent, committed, remaining, percentage, days_remaining, daily_available, income, savings } = data;

            // Budget display
            if (budget.amount > 0) {
                q('#budgetDisplay').textContent = fmtMoney(budget.amount, budget.currency);
            } else {
                q('#budgetDisplay').textContent = 'No budget set';
            }

            // Progress bar
            const pct = Math.min(percentage, 100);
            q('#progressFill').style.width = `${pct}%`;
            q('#progressLabel').textContent = `${Math.round(percentage)}%`;

            // Color based on percentage
            const fill = q('#progressFill');
            fill.classList.remove('green', 'yellow', 'red');
            if (percentage > 100) fill.classList.add('red');
            else if (percentage > 80) fill.classList.add('yellow');
            else fill.classList.add('green');

            // Stats
            q('#statSpent').textContent = fmtMoney(spent, budget.currency);
            q('#statCommitted').textContent = fmtMoney(committed, budget.currency);
            q('#statAvailable').textContent = fmtMoney(remaining, budget.currency);

            // Update colors based on values
            q('#statAvailable').className = 'stat-value ' + (remaining >= 0 ? 'available' : 'spent');

            // Days info - check if future month
            const today = new Date().toISOString().slice(0, 7);
            const isFutureMonth = state.currentMonth > today;
            const isCurrentMonth = state.currentMonth === today;

            // Show/hide future badge
            q('#futureBadge').style.display = isFutureMonth ? 'inline-block' : 'none';

            if (isFutureMonth) {
                q('#daysInfo').innerHTML = `üîÆ <strong>Future month</strong> ¬∑ ${days_remaining} days ¬∑ Expected expenses: <strong>${fmtMoney(committed, budget.currency)}</strong>`;
            } else if (days_remaining > 0 && isCurrentMonth) {
                q('#daysInfo').innerHTML = `üìÖ <strong>${days_remaining}</strong> days remaining ¬∑ <strong>${fmtMoney(daily_available, budget.currency)}</strong>/day available`;
            } else if (days_remaining > 0) {
                q('#daysInfo').innerHTML = `üìÖ <strong>${days_remaining}</strong> days ¬∑ <strong>${fmtMoney(daily_available, budget.currency)}</strong>/day`;
            } else {
                q('#daysInfo').textContent = 'Month completed';
            }

            // Income and savings info (hide for future months)
            const incomeInfo = q('#incomeInfo');
            if (isFutureMonth) {
                incomeInfo.style.display = 'none';
            } else {
                incomeInfo.style.display = 'block';
                q('#incomeValue').textContent = fmtMoney(income, budget.currency);

                const savingsEl = q('#savingsValue');
                savingsEl.textContent = fmtMoney(savings, budget.currency);
                savingsEl.className = 'value ' + (savings >= 0 ? 'positive' : 'negative');
            }
        }

        function renderRecurringList(recurring) {
            const list = q('#recurringList');

            if (!recurring || recurring.length === 0) {
                list.innerHTML = '<div class="empty-state">No recurring expenses<br><small>Click "Detect from history" to find them automatically</small></div>';
                q('#recurringSummary').style.display = 'none';
                return;
            }

            // Sort by amount descending
            const sorted = [...recurring].sort((a, b) => (b.converted_amount || b.amount) - (a.converted_amount || a.amount));

            let totalAmount = 0;
            let paidAmount = 0;

            const freqLabels = { monthly: '', quarterly: 'Quarterly', biannual: 'Biannual', annual: 'Annual' };

            list.innerHTML = sorted.map(r => {
                const amount = r.converted_amount || r.amount;
                totalAmount += amount;
                if (r.paid_this_month) paidAmount += amount;
                const freqLabel = freqLabels[r.frequency] || '';
                const catText = r.category_name || 'No category';
                const subtitle = freqLabel ? `${catText} ¬∑ ${freqLabel}` : catText;

                return `
                    <div class="recurring-item ${r.paid_this_month ? 'paid' : ''}${!r.applies_this_month ? ' not-applicable' : ''}" onclick="editRecurring(${r.id})">
                        <span class="status">${r.paid_this_month ? '‚úì' : (r.applies_this_month ? '‚óã' : '‚Äî')}</span>
                        <div class="info">
                            <div class="name">${r.name}</div>
                            <div class="category">${subtitle}</div>
                        </div>
                        <span class="amount">${fmtMoney(r.amount, r.currency)}</span>
                    </div>
                `;
            }).join('');

            // Summary
            q('#recurringSummary').style.display = 'flex';
            q('#recurringTotal').textContent = fmtMoney(totalAmount, state.baseCurrency);
            q('#recurringPaid').textContent = fmtMoney(paidAmount, state.baseCurrency);
            q('#recurringPending').textContent = fmtMoney(totalAmount - paidAmount, state.baseCurrency);
        }

        function renderPlannedList(planned) {
            const list = q('#plannedList');

            if (!planned || planned.length === 0) {
                list.innerHTML = '<div class="empty-state">No planned expenses<br><small>Add one-time expenses you expect this month</small></div>';
                q('#plannedSummary').style.display = 'none';
                return;
            }

            // Sort by amount descending
            const sorted = [...planned].sort((a, b) => (b.converted_amount || b.amount) - (a.converted_amount || a.amount));

            let totalAmount = 0;
            let paidAmount = 0;

            list.innerHTML = sorted.map(p => {
                const amount = p.converted_amount || p.amount;
                totalAmount += amount;
                if (p.is_paid === 1) paidAmount += amount;

                return `
                    <div class="recurring-item ${p.is_paid === 1 ? 'paid' : ''}" onclick="editPlanned(${p.id})">
                        <span class="status" onclick="event.stopPropagation(); togglePlannedPaid(${p.id})">${p.is_paid === 1 ? '‚úì' : '‚óã'}</span>
                        <div class="info">
                            <div class="name">${p.name}</div>
                            <div class="category">${p.category_name || 'No category'}</div>
                        </div>
                        <span class="amount">${fmtMoney(p.amount, p.currency)}</span>
                    </div>
                `;
            }).join('');

            // Summary
            q('#plannedSummary').style.display = 'flex';
            q('#plannedTotal').textContent = fmtMoney(totalAmount, state.baseCurrency);
            q('#plannedPaid').textContent = fmtMoney(paidAmount, state.baseCurrency);
            q('#plannedPending').textContent = fmtMoney(totalAmount - paidAmount, state.baseCurrency);
        }

        function renderCategoryList(categories) {
            const list = q('#categoryList');

            if (!categories || categories.length === 0) {
                list.innerHTML = '<div class="empty-state">No spending data for this month</div>';
                return;
            }

            const maxAmount = Math.max(...categories.map(c => c.amount));
            const total = categories.reduce((sum, c) => sum + c.amount, 0);

            list.innerHTML = categories.slice(0, 10).map(c => {
                const pct = (c.amount / maxAmount * 100).toFixed(0);
                const totalPct = (c.amount / total * 100).toFixed(1);
                return `
                    <div class="category-item">
                        <span class="name">${c.name}</span>
                        <div class="bar-container">
                            <div class="bar" style="width: ${pct}%"></div>
                        </div>
                        <span class="amount">${fmtMoney(c.amount, state.baseCurrency)} <span class="muted">(${totalPct}%)</span></span>
                    </div>
                `;
            }).join('');
        }

        async function loadBudgetHistory() {
            try {
                const budgets = await api('/budgets?limit=12');
                const list = q('#historyList');

                if (!budgets || budgets.length === 0) {
                    list.innerHTML = '<div class="empty-state">No budget history</div>';
                    return;
                }

                // For each budget, we need to calculate spent percentage
                const historyItems = await Promise.all(budgets.map(async (b) => {
                    try {
                        const progress = await api(`/budgets/${b.year_month}/progress`);
                        return { ...b, spent: progress.spent, percentage: progress.percentage };
                    } catch {
                        return { ...b, spent: 0, percentage: 0 };
                    }
                }));

                list.innerHTML = historyItems.map(h => {
                    const [y, mo] = h.year_month.split('-');
                    const label = new Date(y, mo - 1).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                    const pct = Math.min(h.percentage, 150);
                    const barColor = h.percentage > 100 ? 'var(--red)' : h.percentage > 80 ? 'var(--yellow)' : 'var(--green)';

                    return `
                        <div class="history-item">
                            <div>
                                <div class="month">${label}</div>
                                <div class="budget">${fmtMoney(h.amount, h.currency)}</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" style="width: ${pct / 1.5}%; background: ${barColor}"></div>
                            </div>
                            <span class="percent ${h.percentage > 100 ? 'over' : ''}">${Math.round(h.percentage)}%</span>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error loading history:', e);
            }
        }

        // Budget Modal
        function openBudgetModal() {
            const budget = state.progress?.budget;
            q('#budgetAmount').value = budget?.amount || '';
            openModal('budgetModal');
        }

        async function saveBudget() {
            const amount = parseFloat(q('#budgetAmount').value);
            if (isNaN(amount) || amount < 0) {
                alert('Please enter a valid amount');
                return;
            }

            try {
                await api('/budgets', {
                    method: 'POST',
                    body: JSON.stringify({
                        year_month: state.currentMonth,
                        amount: amount,
                        currency: state.baseCurrency
                    })
                });
                closeModal('budgetModal');
                await loadBudgetProgress();
                await loadBudgetHistory();
            } catch (e) {
                alert('Error saving budget: ' + e.message);
            }
        }

        // Recurring Modal
        function toggleStartMonth() {
            const freq = q('#recurringFrequency').value;
            q('#startMonthGroup').style.display = freq === 'monthly' ? 'none' : 'block';
        }

        function openRecurringModal() {
            q('#recurringModalTitle').textContent = 'Add Recurring Expense';
            q('#recurringId').value = '';
            q('#recurringName').value = '';
            q('#recurringAmount').value = '';
            q('#recurringPayee').value = '';
            q('#recurringCategory').value = '';
            q('#recurringDay').value = '';
            q('#recurringFrequency').value = 'monthly';
            q('#recurringStartMonth').value = new Date().getMonth() + 1;
            q('#startMonthGroup').style.display = 'none';
            q('#deleteRecurringBtn').style.display = 'none';
            openModal('recurringModal');
        }

        async function editRecurring(id) {
            const recurring = state.progress?.recurring_expenses?.find(r => r.id === id);
            if (!recurring) return;

            q('#recurringModalTitle').textContent = 'Edit Recurring Expense';
            q('#recurringId').value = recurring.id;
            q('#recurringName').value = recurring.name;
            q('#recurringAmount').value = recurring.amount;
            q('#recurringPayee').value = recurring.payee_id || '';
            q('#recurringCategory').value = recurring.category_id || '';
            q('#recurringDay').value = recurring.day_of_month || '';
            q('#recurringFrequency').value = recurring.frequency || 'monthly';
            q('#recurringStartMonth').value = recurring.start_month || new Date().getMonth() + 1;
            toggleStartMonth();
            q('#deleteRecurringBtn').style.display = 'block';
            openModal('recurringModal');
        }

        async function saveRecurring() {
            const id = q('#recurringId').value;
            const freq = q('#recurringFrequency').value;
            const data = {
                name: q('#recurringName').value,
                amount: parseFloat(q('#recurringAmount').value),
                payee_id: q('#recurringPayee').value ? parseInt(q('#recurringPayee').value) : null,
                category_id: q('#recurringCategory').value ? parseInt(q('#recurringCategory').value) : null,
                day_of_month: q('#recurringDay').value ? parseInt(q('#recurringDay').value) : null,
                frequency: freq,
                start_month: freq !== 'monthly' ? parseInt(q('#recurringStartMonth').value) : null,
                currency: state.baseCurrency
            };

            if (!data.name || isNaN(data.amount)) {
                alert('Please enter a name and amount');
                return;
            }

            try {
                if (id) {
                    await api(`/recurring/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await api('/recurring', { method: 'POST', body: JSON.stringify(data) });
                }
                closeModal('recurringModal');
                await loadBudgetProgress();
            } catch (e) {
                alert('Error saving: ' + e.message);
            }
        }

        async function deleteRecurring() {
            const id = q('#recurringId').value;
            if (!id) return;

            if (!confirm('Delete this recurring expense?')) return;

            try {
                await api(`/recurring/${id}`, { method: 'DELETE' });
                closeModal('recurringModal');
                await loadBudgetProgress();
            } catch (e) {
                alert('Error deleting: ' + e.message);
            }
        }

        // Planned Expense Modal
        function openPlannedModal() {
            q('#plannedModalTitle').textContent = 'Add Planned Expense';
            q('#plannedId').value = '';
            q('#plannedName').value = '';
            q('#plannedAmount').value = '';
            q('#plannedCategory').value = '';
            q('#deletePlannedBtn').style.display = 'none';
            populatePlannedCategoryDropdown();
            openModal('plannedModal');
        }

        function populatePlannedCategoryDropdown() {
            const select = q('#plannedCategory');
            const sorted = [...state.categories].sort((a, b) => {
                const aLabel = (a.parent ? a.parent + ' > ' : '') + a.name;
                const bLabel = (b.parent ? b.parent + ' > ' : '') + b.name;
                return aLabel.localeCompare(bLabel);
            });
            select.innerHTML = '<option value="">-- Select --</option>' +
                sorted.map(c => `<option value="${c.id}">${c.parent ? c.parent + ' > ' : ''}${c.name}</option>`).join('');
        }

        function editPlanned(id) {
            const planned = state.progress?.planned_expenses?.find(p => p.id === id);
            if (!planned) return;

            q('#plannedModalTitle').textContent = 'Edit Planned Expense';
            q('#plannedId').value = planned.id;
            q('#plannedName').value = planned.name;
            q('#plannedAmount').value = planned.amount;
            populatePlannedCategoryDropdown();
            q('#plannedCategory').value = planned.category_id || '';
            q('#deletePlannedBtn').style.display = 'block';
            openModal('plannedModal');
        }

        async function savePlanned() {
            const id = q('#plannedId').value;
            const data = {
                year_month: state.currentMonth,
                name: q('#plannedName').value,
                amount: parseFloat(q('#plannedAmount').value),
                category_id: q('#plannedCategory').value ? parseInt(q('#plannedCategory').value) : null,
                currency: state.baseCurrency
            };

            if (!data.name || isNaN(data.amount)) {
                alert('Please enter a name and amount');
                return;
            }

            try {
                if (id) {
                    await api(`/planned/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await api('/planned', { method: 'POST', body: JSON.stringify(data) });
                }
                closeModal('plannedModal');
                await loadBudgetProgress();
            } catch (e) {
                alert('Error saving: ' + e.message);
            }
        }

        async function deletePlanned() {
            const id = q('#plannedId').value;
            if (!id) return;

            if (!confirm('Delete this planned expense?')) return;

            try {
                await api(`/planned/${id}`, { method: 'DELETE' });
                closeModal('plannedModal');
                await loadBudgetProgress();
            } catch (e) {
                alert('Error deleting: ' + e.message);
            }
        }

        async function togglePlannedPaid(id) {
            try {
                await api(`/planned/${id}/toggle-paid`, { method: 'PATCH' });
                await loadBudgetProgress();
            } catch (e) {
                alert('Error toggling: ' + e.message);
            }
        }

        // Detect Modal
        async function openDetectModal() {
            openModal('detectModal');
            q('#candidatesList').innerHTML = '<div class="empty-state">Loading...</div>';

            try {
                const candidates = await api('/recurring/detect');

                if (!candidates || candidates.length === 0) {
                    q('#candidatesList').innerHTML = '<div class="empty-state">No recurring expenses detected<br><small>Try lowering the criteria or add them manually</small></div>';
                    return;
                }

                q('#candidatesList').innerHTML = candidates.map((c, i) => `
                    <div class="candidate-item">
                        <input type="checkbox" id="candidate_${i}" data-index="${i}">
                        <div class="info">
                            <div class="payee">${c.payee_name}</div>
                            <div class="details">${c.occurrences} months ¬∑ Day ~${c.average_day} ¬∑ ${c.category_name || 'No category'}</div>
                        </div>
                        <span class="amount">${fmtMoney(c.average_amount, c.currency)}</span>
                    </div>
                `).join('');

                // Store candidates for later
                state.candidates = candidates;
            } catch (e) {
                q('#candidatesList').innerHTML = '<div class="empty-state">Error detecting: ' + e.message + '</div>';
            }
        }

        async function addSelectedCandidates() {
            const checkboxes = qa('#candidatesList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one expense');
                return;
            }

            try {
                for (const cb of checkboxes) {
                    const idx = parseInt(cb.dataset.index);
                    const c = state.candidates[idx];
                    await api('/recurring', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: c.suggested_name,
                            payee_id: c.payee_id,
                            category_id: c.category_id,
                            amount: c.average_amount,
                            currency: c.currency,
                            day_of_month: c.average_day
                        })
                    });
                }
                closeModal('detectModal');
                await loadBudgetProgress();
            } catch (e) {
                alert('Error adding: ' + e.message);
            }
        }

        // Month navigation
        q('#selectMonth').onchange = (e) => {
            state.currentMonth = e.target.value;
            loadBudgetProgress();
        };

        q('#btnPrevMonth').onclick = () => {
            const s = q('#selectMonth');
            if (s.selectedIndex < s.options.length - 1) {
                s.selectedIndex++;
                state.currentMonth = s.value;
                loadBudgetProgress();
            }
        };

        q('#btnNextMonth').onclick = () => {
            const s = q('#selectMonth');
            if (s.selectedIndex > 0) {
                s.selectedIndex--;
                state.currentMonth = s.value;
                loadBudgetProgress();
            }
        };

        // Init on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
