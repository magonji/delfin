<!doctype html>
<html lang="en-GB">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Delfin ¬∑ The Dashboard</title>
    <link rel="icon" href="favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #FFF1E6; --panel: #FEE5D7; --card: #D4B5A0; --border: #D4B5A0;
            --muted: #5F5F5F; --text: #2D2D2D;
            --green: #0e9530; --red: #d52811; --yellow: #f5b700;
            --page-gutter: clamp(10px, 4vw, 20px);
        }

        * { box-sizing: border-box; }
        html { height: 100%; scrollbar-gutter: stable both-edges; }
        body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: 'IBM Plex Mono', monospace; }

        /* Header and toolbar */
        header { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px; position: static; backdrop-filter: blur(8px); background: #FEE5D7; border-bottom: 1px solid #D4B5A0; z-index: 10; }
        h1 { font-size: 30px; margin: 0; letter-spacing: 0.2px; font-family: 'Playfair Display', serif; }

        /* Toolbar controls */
        .tools { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .tools select, .tools input, .tools button, .dropdown .btn {
            background: var(--bg); color: var(--text); border: 1px solid var(--border);
            border-radius: 8px; padding: 6px 10px; font-size: 12px; cursor: pointer;
        }
        .tools button { cursor: pointer; }
        .tools .primary { background: var(--panel); border-color: var(--border); }
        .tools .danger { background: var(--panel); border-color: var(--border); }

        /* KPI cards */
        .kpis { display: grid; grid-template-columns: repeat(4, minmax(180px, 1fr)); gap: 12px; margin: 12px 20px; }
        .kpi { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 14px; }
        .kpi h3 { margin: 0 0 6px 0; color: var(--muted); font-size: 14px; font-weight: 600; font-family: 'IBM Plex Sans', sans-serif; text-transform: uppercase; letter-spacing: 2px; }
        .kpi .value { font-size: 22px; font-weight: 700; }
        #ysExpenses, #totExpenses { color: var(--red) !important; }

        /* Layout grids */
        .container { display: grid; grid-template-columns: 1.3fr 0.7fr; gap: 14px; margin: 0 20px 40px; }
        .two-col-cards { display: grid; padding-inline: var(--page-gutter); grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px; align-items: stretch; }
        .two-col-cards .card, .container.cat-accounts > .card { height: 100%; }
        .two-col-cards canvas { width: 100% !important; height: 400px; max-width: 100%; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }

        /* Card component */
        .card { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .card.full { grid-column: 1 / -1; }
        .card .head { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid var(--border); background: var(--bg); }
        .card .title { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 2px; font-family: 'IBM Plex Sans', sans-serif; text-transform: uppercase; }
        .card .content { padding: 12px 14px; }

        /* List rows */
        .list { display: flex; flex-direction: column; gap: 8px; }
        .list .row { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: var(--bg); align-items: center; }
        .list.list--2col { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
        .list.list--2col .row { height: 100%; }
        .list .row > :first-child { min-width: 0; }
        .list .row .title, #accountsList .row .name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #accountsList .row { grid-template-columns: 1fr auto; padding: 8px 10px; }
        
        /* Top expenses and transactions lists */
        #topExpenses .row, #topTx .row { display: grid !important; grid-template-columns: 1fr auto !important; align-items: center; gap: 8px; }
        #topExpenses .row > :first-child, #topTx .row > :first-child { min-width: 0; }
        .row strong, .row .muted { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .row .right { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; min-width: 140px; text-align: right; }
        .row .amt { font-size: 20px; font-weight: 800; line-height: 1.1; color: var(--red); font-variant-numeric: tabular-nums; }
        .row .date { font-size: 14px; color: var(--muted); }

        .title_te { color: var(--muted); font-size: 18px; font-weight: 600; font-family: 'IBM Plex Sans', sans-serif; text-transform: uppercase; letter-spacing: 2px; padding-top: 30px; padding-bottom: 10px; }

        /* Dropdown menus */
        .dropdown { position: relative; }
        .dropdown .btn { display: flex; align-items: center; gap: 8px; }
        .dropdown .btn .count { background: var(--bg); border: 1px solid var(--border); border-radius: 999px; padding: 1px 6px; font-size: 11px; }
        .dropdown .menu { position: absolute; top: calc(100% + 6px); right: 0; min-width: 280px; max-height: 280px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); display: none; padding: 8px; z-index: 20; }
        .dropdown.open .menu { display: block; }
        .dropdown .menu .search input { width: 100%; margin-bottom: 6px; }
        .dropdown .menu .actions { display: flex; gap: 6px; margin: 6px 0; }
        .dropdown .menu .list { max-height: 180px; overflow: auto; display: flex; flex-direction: column; gap: 4px; }
        .dropdown .menu label { display: flex; align-items: center; gap: 8px; padding: 6px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); cursor: pointer; }
        .dropdown .menu input[type="checkbox"] { accent-color: var(--card); }
        
        #navDropdown .menu { min-width: 180px; }
        #navDropdown .navItem { 
            width: 100%; 
            text-align: left; 
            padding: 8px 12px; 
            background: transparent; 
            cursor: pointer; 
            border: none !important;
            border-radius: 6px;
            transition: background 0.2s;
            font-size: 14px;
            font-weight: 600;
            font-family: 'IBM Plex Sans', sans-serif; color: var(--text);
        }
        #navDropdown .navItem:hover { background: var(--panel); }

        /* Category accordion */
        .cat-group { margin-bottom: 4px; }
        .cat-group-header { 
            display: flex; align-items: center; gap: 8px; padding: 8px; 
            border-radius: 8px; border: 1px solid var(--border); background: var(--panel); 
            cursor: pointer; font-weight: 600; font-size: 13px;
        }
        .cat-group-header:hover { background: var(--card); }
        .cat-group-header .arrow { transition: transform 0.2s; font-size: 10px; }
        .cat-group.open .cat-group-header .arrow { transform: rotate(90deg); }
        .cat-group-children { display: none; padding-left: 16px; margin-top: 4px; }
        .cat-group.open .cat-group-children { display: flex; flex-direction: column; gap: 4px; }
        .cat-group-children label { font-size: 12px; padding: 5px 8px; }

        /* Charts and utilities */
        .cat-monthly .chart-center { display: flex; align-items: center; justify-content: center; padding: 6px 0; }
        .cat-monthly .chart-box { width: 560px; height: 560px; }
        .cat-monthly #catPie { width: 100% !important; height: 100% !important; display: block; padding: 40px; }
        
        .muted { color: var(--muted); }
        .badge { padding: 2px 6px; border-radius: 999px; font-size: 11px; background: var(--card); border: 1px solid var(--border); }
        .badge_spe { display: inline-flex; justify-content: center; align-items: center; width: 60px; height: 25px; border-radius: 999px; margin-right: 15px; font-size: 14px; font-weight: 400; background: var(--panel); border: 1px solid var(--border); color: var(--text); word-spacing: -5px; }
        .legend { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px; }
        .legend .dot { width: 10px; height: 10px; border-radius: 50%; }
        .footer { opacity: 0.7; font-size: 12px; text-align: center; margin: 24px 10px; padding-bottom: 10px; font-family: 'Playfair Display', serif; }

        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr; }
            .cat-monthly .chart-box { width: 300px; height: 300px; }
        }
        @media (max-width: 900px) {
            .list.list--2col, .two-col-cards { grid-template-columns: 1fr; }
            .cat-monthly .chart-box { width: 260px; height: 260px; }
        }
    </style>
</head>
<body>
    <header>
        <h1>üê¨ Delfin ¬∑ The Dashboard</h1>
        <div class="tools">
            <span class="badge" id="baseCurrency">‚Äî</span>
            <button id="btnRefresh" class="primary">üîÑ Refresh</button>
            <button id="btnUpdateRates" class="danger">üí± Update rates</button>
            <div class="dropdown" id="navDropdown">
                <button class="btn" id="navBtn" onclick="toggleNav()">üìÇ Menu ‚ñæ</button>
                <div class="menu" id="navMenu">
                    <div class="list" style="padding: 6px;">
                        <button class="navItem" onclick="location.href='transactions.html'">üìë Transactions</button>
                        <button class="navItem" onclick="location.href='loans.html'">üí∞ Loans</button>
                        <button class="navItem" onclick="location.href='tools.html'">üõ†Ô∏è Tools</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <section class="kpis" id="kpis">
        <div class="kpi"><h3>Total balance</h3><div class="value" id="kpiTotalBalance">‚Äî</div></div>
        <div class="kpi"><h3>Transactions</h3><div class="value" id="kpiTxCount">‚Äî</div></div>
        <div class="kpi"><h3>Active accounts</h3><div class="value" id="kpiAccounts">‚Äî</div></div>
        <div class="kpi"><h3>Categories</h3><div class="value" id="kpiCategories">‚Äî</div></div>
    </section>

    <section class="container">
        <div class="card full">
            <div class="head">
                <h2 class="title">Net Worth Evolution</h2>
                <div class="tools">
                    <select id="nwPeriod"><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly" selected>Monthly</option></select>
                    <select id="nwRange"><option value="all">All time</option><option value="last12">Last year</option><option value="last6">Last 6 months</option><option value="last3">Last 3 months</option><option value="last1">Last month</option></select>
                    <div class="dropdown" id="excludeDropdown">
                        <button class="btn" id="excludeBtn" onclick="toggleExclude()">Exclude accounts <span class="count" id="excludeCount">0</span> ‚ñæ</button>
                        <div class="menu" id="excludeMenu">
                            <div class="search"><input type="text" id="excludeSearch" placeholder="Search accounts..."></div>
                            <div class="actions"><button id="excludeSelectAll">Select all</button><button id="excludeClear">Clear</button></div>
                            <div class="list" id="excludeList"></div>
                        </div>
                    </div>
                    <button id="applyNetworth" class="primary" style="display:none;">Apply</button>
                </div>
            </div>
            <div class="content">
                <canvas id="networthChart" height="125"></canvas>
                <div class="grid-4" style="margin-top: 12px;">
                    <div class="kpi"><h3>Initial</h3><div class="value" id="nwInitial">‚Äî</div></div>
                    <div class="kpi"><h3>Current</h3><div class="value" id="nwCurrent">‚Äî</div></div>
                    <div class="kpi"><h3>Change</h3><div class="value" id="nwChange">‚Äî</div></div>
                    <div class="kpi"><h3>Peak / Low</h3><div class="value" id="nwExtremes"><span id="nwPeak">‚Äî</span> / <span id="nwLow">‚Äî</span></div></div>
                </div>
            </div>
        </div>
    </section>

    <section class="container cat-accounts">
        <div class="card cat-monthly">
            <div class="head">
                <h2 class="title">Monthly category spend</h2>
                <div class="tools">
                    <button id="btnPrevMonth">‚óÄ</button><select id="selectMonth"></select><button id="btnNextMonth">‚ñ∂</button>
                    <select id="selectViewMode">
                        <option value="top">Top expenses</option>
                        <option value="category">By category</option>
                        <option value="subcategory">By subcategory</option>
                    </select>
                </div>
            </div>
            <div class="content">
                <div class="chart-center"><div class="chart-box"><canvas id="catPie"></canvas></div></div>
                <div><h3 class="title_te" id="monthlyListTitle" style="margin: 6px 15px 8px;">Top 10 expenses this month</h3><div id="topExpenses" class="list list--2col" style="margin: 6px 15px 8px;"></div></div>
            </div>
        </div>
        <div class="card">
            <div class="head"><h2 class="title">Balance by account</h2></div>
            <div class="content"><div id="accountsList" class="list" style="margin-top: 10px;"></div></div>
        </div>
    </section>

    <section class="two-col-cards">
        <div class="card">
            <div class="head"><h2 class="title">Monthly trend (year)</h2><div class="tools"><select id="selectYear"></select></div></div>
            <div class="content">
                <canvas id="yearChart" height="400"></canvas>
                <div class="kpis" style="grid-template-columns: repeat(3, 1fr); margin: 12px 0 0;">
                    <div class="kpi"><h3>Total income</h3><div class="value" id="ysIncome">‚Äî</div></div>
                    <div class="kpi"><h3>Total expenses</h3><div class="value" id="ysExpenses">‚Äî</div></div>
                    <div class="kpi"><h3>Net savings</h3><div class="value" id="ysNet">‚Äî</div></div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="head"><h2 class="title">Yearly trend</h2></div>
            <div class="content">
                <canvas id="yearlyTrendChart" height="400"></canvas>
                <div class="kpis" style="grid-template-columns: repeat(3, 1fr); margin: 12px 0 0;">
                    <div class="kpi"><h3>Total income</h3><div class="value" id="totIncome">‚Äî</div></div>
                    <div class="kpi"><h3>Total expenses</h3><div class="value" id="totExpenses">‚Äî</div></div>
                    <div class="kpi"><h3>Net savings</h3><div class="value" id="totNet">‚Äî</div></div>
                </div>
            </div>
        </div>
    </section>

    <section class="container" style="margin-top: 50px;">
        <div class="card full">
            <div class="head">
                <h2 class="title">Category spending trend</h2>
                <div class="tools">
                    <select id="catPeriod"><option value="monthly" selected>Monthly</option><option value="weekly">Weekly</option><option value="daily">Daily</option></select>
                    <select id="catRange"><option value="last12" selected>Last year</option><option value="last6">Last 6 months</option><option value="last3">Last 3 months</option><option value="last1">Last month</option><option value="all">All time</option></select>
                    <div class="dropdown" id="categoriesDropdown">
                        <button class="btn" id="categoriesBtn" onclick="toggleCategories()">Select categories <span class="count" id="categoriesCount">0</span> ‚ñæ</button>
                        <div class="menu" id="categoriesMenu" style="max-height: 400px;">
                            <div class="search" style="margin-bottom: 6px;"><input type="text" id="categoriesSearch" placeholder="Search categories..."></div>
                            <div class="actions" style="margin: 6px 0;"><button id="categoriesSelectAll">Select all</button><button id="categoriesClear">Clear</button></div>
                            <div class="list" id="categoriesList" style="max-height: 300px; overflow: auto;"></div>
                        </div>
                    </div>
                    </div>
            </div>
            <div class="content"><canvas id="categoriesChart" height="200"></canvas><div id="categoriesLegend" class="legend"></div></div>
        </div>
    </section>

    <section class="two-col-cards">
        <div class="card">
            <div class="head">
                <h2 class="title" id="topPayeesTitle">Top 20 Payees</h2>
                <div class="tools">
                    <select id="payeeType">
                        <option value="payees" selected>Payees</option>
                        <option value="locations">Locations</option>
                    </select>
                    <select id="payeeRange"><option value="last12" selected>Last year</option><option value="last6">Last 6 months</option><option value="last3">Last 3 months</option><option value="last1">Last month</option><option value="all">All time</option></select>
                </div>
            </div>
            <div class="content"><div id="topPayees" class="list"></div></div>
        </div>
        <div class="card">
            <div class="head">
                <h2 class="title" id="topTxTitle">Top 20 individual expenses</h2>
                <div class="tools">
                    <select id="txType">
                        <option value="expenses" selected>Expenses</option>
                        <option value="income">Income</option>
                    </select>
                    <select id="txRange"><option value="last12" selected>Last year</option><option value="last6">Last 6 months</option><option value="last3">Last 3 months</option><option value="last1">Last month</option><option value="all">All time</option></select>
                </div>
            </div>
            <div class="content"><div id="topTx" class="list"></div></div>
        </div>
    </section>

    <div class="footer">¬© Royal Bank of Gonz√°lez. 2025</div>

<script>
// Configuration
const API_BASE = (localStorage.getItem('delfin_api') || 'http://localhost:8000').replace(/\/$/, '');
const EPS = 0.005;
const PALETTE = [
    '#F5B700', '#386481', '#D52811', '#1B9F9A', '#525252', '#00689D',
    '#C7437D', '#0E9530', '#C59A00', '#6C2FA2', '#F07F2F', '#006400',
    '#4D9A4D', '#9B7BC9', '#7BA8C4', '#E87A6B', '#66C4C0', '#90C490',
    '#E89BBF', '#5FBF5F', '#E6C266', '#F5B88C'
];

// Helpers
const q = (sel) => document.querySelector(sel);
const qa = (sel) => Array.from(document.querySelectorAll(sel));
const fmtMoney = (n, c = 'GBP') => new Intl.NumberFormat('en-GB', { style: 'currency', currency: c, maximumFractionDigits: 2 }).format(n || 0);
const colour = (i) => PALETTE[i % PALETTE.length];

// API and caching (14-day TTL)
async function api(path, opts = {}) {
    const res = await fetch(`${API_BASE}${path}`, { headers: { 'Content-Type': 'application/json' }, ...opts });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text();
}

function cacheSet(key, data, ttl = 1209600) {
    localStorage.setItem(key, JSON.stringify({ data, expiry: Date.now() + ttl * 1000 }));
}

function cacheGet(key) {
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    try {
        const { data, expiry } = JSON.parse(raw);
        return Date.now() > expiry ? (localStorage.removeItem(key), null) : data;
    } catch { return null; }
}

function cacheClearAll() {
    Object.keys(localStorage).filter(k => k.startsWith('cache_')).forEach(k => localStorage.removeItem(k));
}

// Application state
const state = { baseCurrency: 'GBP', months: [], categories: [], accounts: [], excludedAccountIds: new Set(), selectedCategoryIds: new Set() };

// Chart rendering
function renderChart(canvasId, config, globalVarName) {
    if (window[globalVarName]) window[globalVarName].destroy();
    window[globalVarName] = new Chart(q(canvasId), config);
}

// Convert date range key to from/to dates
function rangeFor(key) {
    const today = new Date();
    let from = null;
    if (key !== 'all') {
        from = new Date(today);
        if (key === 'last12') from.setMonth(from.getMonth() - 12);
        else if (key === 'last6') from.setMonth(from.getMonth() - 6);
        else if (key === 'last3') from.setMonth(from.getMonth() - 3);
        else if (key === 'last1') from.setMonth(from.getMonth() - 1);
    }
    return { from: from?.toISOString().slice(0, 10), to: key !== 'all' ? today.toISOString().slice(0, 10) : null };
}

async function loadSummary() {
    let sum = cacheGet('cache_summary') || await api('/dashboard/summary').then(d => { cacheSet('cache_summary', d); return d; });
    state.baseCurrency = sum.base_currency || 'GBP';
    q('#baseCurrency').textContent = state.baseCurrency;
    
    const setKPI = (id, val, isMoney = false) => {
        const el = q(id);
        el.textContent = isMoney ? fmtMoney(Math.abs(val), state.baseCurrency) : val.toLocaleString('en-GB');
        if (isMoney) el.style.color = val > 0 ? 'var(--green)' : val < 0 ? 'var(--red)' : 'var(--text)';
    };

    setKPI('#kpiTotalBalance', sum.total_balance, true);
    setKPI('#kpiTxCount', sum.total_transactions);
    setKPI('#kpiAccounts', sum.total_accounts);
    setKPI('#kpiCategories', sum.total_categories);
}

async function loadAccounts() {
    let data = cacheGet('cache_accounts') || await api('/accounts/with-balances').then(d => { cacheSet('cache_accounts', d); return d; });
    state.accounts = data.sort((a, b) => (b.current_balance || 0) - (a.current_balance || 0));
    renderExcludeList();

    const list = q('#accountsList');
    list.innerHTML = '';
    state.accounts.forEach(a => {
        const amt = a.current_balance ?? a.initial_balance ?? 0;
        const row = document.createElement('div');
        row.className = 'row';
        const color = amt > 0 ? 'var(--green)' : amt < 0 ? 'var(--red)' : 'var(--text)';
        row.innerHTML = `<div class="name"><strong>${a.name}</strong></div><div class="amount" style="color:${color};font-weight:700;">${fmtMoney(Math.abs(amt), a.currency)}</div>`;
        list.appendChild(row);
    });
}

function renderExcludeList() {
    const list = q('#excludeList');
    list.innerHTML = '';
    const term = q('#excludeSearch').value.toLowerCase();
    state.accounts.filter(a => !term || a.name.toLowerCase().includes(term)).forEach(a => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${a.id}" ${state.excludedAccountIds.has(a.id) ? 'checked' : ''}><span>${a.name}</span><span class="muted" style="margin-left:auto">${a.currency}</span>`;
        label.querySelector('input').onchange = (e) => {
            const val = parseInt(e.target.value);
            e.target.checked ? state.excludedAccountIds.add(val) : state.excludedAccountIds.delete(val);
            q('#excludeCount').textContent = state.excludedAccountIds.size;
            loadNetworth();
        };
        list.appendChild(label);
    });
    q('#excludeCount').textContent = state.excludedAccountIds.size;
}

async function loadNetworth() {
    const period = q('#nwPeriod').value;
    const { from, to } = rangeFor(q('#nwRange').value);
    const excluded = Array.from(state.excludedAccountIds).join(',');
    const cacheKey = `cache_nw_${period}_${from}_${to}_${excluded}`;
    
    let data = cacheGet(cacheKey);
    if (!data) {
        const ps = new URLSearchParams();
        if (from) ps.set('date_from', from);
        if (to) ps.set('date_to', to);
        if (excluded) ps.set('excluded_accounts', excluded);
        data = await api(`/dashboard/networth/${period}?${ps}`);
        cacheSet(cacheKey, data);
    }

    renderChart('#networthChart', {
        type: 'line',
        data: {
            labels: data.data_points.map(p => p.date),
            datasets: [{ label: `Net worth`, data: data.data_points.map(p => p.balance), borderColor: '#0e9530', backgroundColor: 'rgba(14, 159, 48, .15)', fill: true, tension: 0.5 }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: { x: { grid: { color: 'transparent' }, ticks: { maxTicksLimit: 6 } }, y: { grid: { color: '#D4B5A0' } } }
        }
    }, '_nwChart');

    const s = data.summary || {};
    const updateKpi = (id, val) => {
        const el = q(id);
        el.textContent = fmtMoney(Math.abs(val || 0), data.base_currency);
        el.style.color = (val || 0) >= 0 ? 'var(--green)' : 'var(--red)';
    };
    updateKpi('#nwInitial', s.initial_balance);
    updateKpi('#nwCurrent', s.current_balance);
    updateKpi('#nwPeak', s.peak_balance);
    updateKpi('#nwLow', s.lowest_balance);
    
    const changeEl = q('#nwChange');
    changeEl.textContent = `${fmtMoney(s.total_change, data.base_currency)} (${s.percentage_change}%)`;
    changeEl.style.color = s.total_change >= 0 ? 'var(--green)' : 'var(--red)';
}

async function loadAvailableMonths() {
    const cacheKey = 'cache_available_months';
    const res = cacheGet(cacheKey) || await api('/dashboard/available-months').then(d => { cacheSet(cacheKey, d); return d; });
    state.months = res.months || [];
    const sel = q('#selectMonth');
    sel.innerHTML = state.months.map(m => `<option value="${m.value}">${m.label}</option>`).join('');
    if (state.months.length) loadMonthlyBreakdown(state.months[0].value);
}

async function loadMonthlyBreakdown(ym) {
    const viewMode = q('#selectViewMode').value;
    const cacheKey = `cache_monthly_${ym}_${viewMode}`;
    const data = cacheGet(cacheKey) || await api(`/dashboard/categories/breakdown/${ym}?view_mode=${viewMode}`).then(d => { cacheSet(cacheKey, d); return d; });
    const labels = data.categories.map(c => c.name);
    
    renderChart('#catPie', {
        type: 'doughnut',
        data: { labels, datasets: [{ data: data.categories.map(c => c.amount), backgroundColor: labels.map((_, i) => colour(i)) }] },
        options: { maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false } } }
    }, '_pie');

    const list = q('#topExpenses');
    const titleEl = q('#monthlyListTitle');
    list.innerHTML = '';
    
    if (viewMode === 'top') {
        titleEl.textContent = 'Top 10 expenses this month';
        (data.top_expenses || []).forEach(tx => {
            const row = document.createElement('div');
            row.className = 'row';
            row.innerHTML = `<div><strong>${tx.payee || '‚Äî'}</strong><div class="muted">${tx.category || 'Uncat.'}</div></div><div class="right"><div class="amt">${fmtMoney(tx.amount, data.base_currency)}</div><div class="date">${new Date(tx.date).toLocaleDateString('en-GB')}</div></div>`;
            list.appendChild(row);
        });
    } else {
        titleEl.textContent = viewMode === 'category' ? 'Spending by category' : 'Spending by subcategory';
        (data.categories || []).forEach(cat => {
            const row = document.createElement('div');
            row.className = 'row';
            row.innerHTML = `<div><strong>${cat.name}</strong><div class="muted">${cat.transaction_count} transactions</div></div><div class="right"><div class="amt">${fmtMoney(cat.amount, data.base_currency)}</div><div class="date">${cat.percentage}%</div></div>`;
            list.appendChild(row);
        });
    }
}

async function loadYearlySummary(year) {
    const cacheKey = `cache_yearly_${year}`;
    const data = cacheGet(cacheKey) || await api(`/dashboard/yearly-summary?year=${year}`).then(d => { cacheSet(cacheKey, d); return d; });
    renderChart('#yearChart', {
        data: {
            labels: data.monthly_data.map(m => m.month),
            datasets: [
                { type: 'line', label: 'Net', data: data.monthly_data.map(m => m.net), borderColor: '#00689d', tension: 0.1 },
                { type: 'bar', label: 'In', data: data.monthly_data.map(m => m.income), backgroundColor: '#0e9530' },
                { type: 'bar', label: 'Out', data: data.monthly_data.map(m => m.expenses), backgroundColor: '#d52811' }
            ]
        },
        options: { scales: { x: { grid: { color: 'transparent' } }, y: { grid: { color: '#D4B5A0' } } } }
    }, '_yearChart');

    const setVal = (id, val) => { q(id).textContent = fmtMoney(val, data.base_currency); q(id).style.color = val >= 0 ? 'var(--green)' : 'var(--red)'; };
    const setValNoColor = (id, val) => { q(id).textContent = fmtMoney(val, data.base_currency); };
    setVal('#ysIncome', data.summary.total_income);
    setValNoColor('#ysExpenses', data.summary.total_expenses);
    setVal('#ysNet', data.summary.net_savings);
}

async function loadYearlyTrendAll() {
    const years = [...new Set(state.months.map(m => m.year))].sort((a, b) => a - b);
    if (!years.length) return;
    
    const results = await Promise.all(years.map(y => {
        const cacheKey = `cache_yearly_${y}`;
        return cacheGet(cacheKey) || api(`/dashboard/yearly-summary?year=${y}`).then(d => { cacheSet(cacheKey, d); return d; });
    }));
    const base = results[0]?.base_currency || 'GBP';
    const totals = (prop) => results.map(r => r.summary[prop]);

    renderChart('#yearlyTrendChart', {
        data: {
            labels: years,
            datasets: [
                { type: 'line', label: 'Net', data: totals('net_savings'), borderColor: '#00689d', tension: 0.1 },
                { type: 'bar', label: 'In', data: totals('total_income'), backgroundColor: '#0e9530' },
                { type: 'bar', label: 'Out', data: totals('total_expenses'), backgroundColor: '#d52811' }
            ]
        },
        options: { scales: { x: { grid: { color: 'transparent' } }, y: { grid: { color: '#D4B5A0' } } } }
    }, '_yearlyTrend');

    const sum = arr => arr.reduce((a, b) => a + (Number(b) || 0), 0);
    const setVal = (id, val) => { q(id).textContent = fmtMoney(val, base); q(id).style.color = val >= 0 ? 'var(--green)' : 'var(--red)'; };
    const setValNoColor = (id, val) => { q(id).textContent = fmtMoney(val, base); };
    setVal('#totIncome', sum(totals('total_income')));
    setValNoColor('#totExpenses', sum(totals('total_expenses')));
    setVal('#totNet', sum(totals('net_savings')));
}

function renderCategoriesList() {
    const list = q('#categoriesList');
    list.innerHTML = '';
    const term = q('#categoriesSearch').value.toLowerCase();
    
    const grouped = {};
    const noParent = [];
    
    state.categories.forEach(c => {
        if (term && !c.name.toLowerCase().includes(term) && !(c.parent && c.parent.toLowerCase().includes(term))) {
            return;
        }
        
        if (c.parent) {
            if (!grouped[c.parent]) {
                grouped[c.parent] = [];
            }
            grouped[c.parent].push(c);
        } else {
            noParent.push(c);
        }
    });
    
    const sortedParents = Object.keys(grouped).sort((a, b) => a.localeCompare(b));
    
    sortedParents.forEach(parentName => {
        const children = grouped[parentName].sort((a, b) => a.name.localeCompare(b.name));
        const group = document.createElement('div');
        group.className = 'cat-group';
        
        const anySelected = children.some(c => state.selectedCategoryIds.has(c.id));
        const allSelected = children.every(c => state.selectedCategoryIds.has(c.id));
        
        group.innerHTML = `
            <div class="cat-group-header">
                <span class="arrow">‚ñ∂</span>
                <input type="checkbox" class="parent-check" ${allSelected ? 'checked' : ''} ${anySelected && !allSelected ? 'indeterminate' : ''}>
                <span>${parentName}</span>
                <span class="muted" style="margin-left:auto;font-size:11px;">${children.length}</span>
            </div>
            <div class="cat-group-children"></div>
        `;
        
        const header = group.querySelector('.cat-group-header');
        const childrenContainer = group.querySelector('.cat-group-children');
        const parentCheck = group.querySelector('.parent-check');
        
        if (anySelected && !allSelected) {
            parentCheck.indeterminate = true;
        }
        
        header.addEventListener('click', (e) => {
            if (e.target.type !== 'checkbox') {
                group.classList.toggle('open');
            }
        });
        
        parentCheck.addEventListener('change', (e) => {
            e.stopPropagation();
            children.forEach(c => {
                if (e.target.checked) {
                    state.selectedCategoryIds.add(c.id);
                } else {
                    state.selectedCategoryIds.delete(c.id);
                }
            });
            childrenContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = e.target.checked;
            });
            q('#categoriesCount').textContent = state.selectedCategoryIds.size;
            loadCategoriesSeries();
        });
        
        children.forEach(c => {
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${c.id}" ${state.selectedCategoryIds.has(c.id) ? 'checked' : ''}><span>${c.name}</span>`;
            label.querySelector('input').onchange = (e) => {
                const val = parseInt(e.target.value);
                e.target.checked ? state.selectedCategoryIds.add(val) : state.selectedCategoryIds.delete(val);
                q('#categoriesCount').textContent = state.selectedCategoryIds.size;
                
                const allNowSelected = children.every(ch => state.selectedCategoryIds.has(ch.id));
                const anyNowSelected = children.some(ch => state.selectedCategoryIds.has(ch.id));
                parentCheck.checked = allNowSelected;
                parentCheck.indeterminate = anyNowSelected && !allNowSelected;
                loadCategoriesSeries();
            };
            childrenContainer.appendChild(label);
        });
        
        list.appendChild(group);
    });
    
    if (noParent.length > 0) {
        noParent.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${c.id}" ${state.selectedCategoryIds.has(c.id) ? 'checked' : ''}><span>${c.name}</span>`;
            label.querySelector('input').onchange = (e) => {
                const val = parseInt(e.target.value);
                e.target.checked ? state.selectedCategoryIds.add(val) : state.selectedCategoryIds.delete(val);
                q('#categoriesCount').textContent = state.selectedCategoryIds.size;
                loadCategoriesSeries();
            };
            list.appendChild(label);
        });
    }
    
    q('#categoriesCount').textContent = state.selectedCategoryIds.size;
}

async function loadCategoriesSeries() {
    if (!state.selectedCategoryIds.size) { if (window._catChart) window._catChart.destroy(); q('#categoriesLegend').innerHTML = ''; return; }
    
    const period = q('#catPeriod').value;
    const { from, to } = rangeFor(q('#catRange').value);
    const catIds = Array.from(state.selectedCategoryIds).sort().join(',');
    const ps = new URLSearchParams();
    if (from) ps.set('date_from', from);
    if (to) ps.set('date_to', to);
    ps.set('category_ids', catIds);

    const cacheKey = `cache_catseries_${period}_${from}_${to}_${catIds}`;
    const data = cacheGet(cacheKey) || await api(`/dashboard/categories/${period}?${ps}`).then(d => { cacheSet(cacheKey, d); return d; });
    const datasets = Object.entries(data.categories).map(([name, vals], i) => ({ label: name, data: vals, borderColor: colour(i), tension: 0.1, fill: false }));

    renderChart('#categoriesChart', {
        type: 'line',
        data: { labels: data.periods, datasets },
        options: { plugins: { legend: { display: false } }, scales: { x: { grid: { color: 'transparent' } }, y: { grid: { color: '#D4B5A0' } } } }
    }, '_catChart');

    q('#categoriesLegend').innerHTML = datasets.map((ds) => `<div style="display:flex;align-items:center;gap:6px"><span class="dot" style="background:${ds.borderColor}"></span> ${ds.label}</div>`).join('');
}

// Load top payees/locations or transactions
async function loadTopList(url, listId, isTx = false) {
    const { from, to } = rangeFor(q(isTx ? '#txRange' : '#payeeRange').value);
    const txType = isTx ? q('#txType').value : 'expenses';
    const payeeType = !isTx ? q('#payeeType').value : 'payees';
    const ps = new URLSearchParams({ limit: '20' });
    if (from) ps.set('date_from', from);
    if (to) ps.set('date_to', to);
    if (isTx) {
        ps.set('exclude_transfers', 'true');
        ps.set('type', txType);
    }

    const actualUrl = !isTx && payeeType === 'locations' ? '/dashboard/top-locations' : url;
    
    const cacheKey = `cache_${listId}_${from}_${to}_${isTx ? txType : payeeType}`;
    let data = cacheGet(cacheKey) || await api(`${actualUrl}?${ps}`).then(d => { cacheSet(cacheKey, d); return d; });
    const list = q(`#${listId}`);
    list.innerHTML = '';

    if (isTx) {
        const count = (data.items || []).length;
        q('#topTxTitle').textContent = txType === 'income' 
            ? `Top ${count} individual income` 
            : `Top ${count} individual expenses`;
    } else {
        const count = (data[payeeType] || []).length;
        q('#topPayeesTitle').textContent = payeeType === 'locations'
            ? `Top ${count} Locations`
            : `Top ${count} Payees`;
    }

    const isIncome = txType === 'income';
    const dataKey = isTx ? 'items' : payeeType;
    (data[dataKey] || []).forEach(item => {
        const row = document.createElement('div');
        row.className = 'row';
        if (isTx) {
            row.innerHTML = `<div><strong>${item.payee}</strong><div class="muted">${item.category}</div></div><div class="right"><div class="amt" style="color: var(--${isIncome ? 'green' : 'red'})">${fmtMoney(item.amount, data.base_currency)}</div><div class="date">${new Date(item.date).toLocaleDateString('en-GB')}</div></div>`;
        } else if (payeeType === 'locations') {
            row.innerHTML = `<div><strong>${item.name}</strong></div><div class="right"><div class="amt">${fmtMoney(item.total_spent, data.base_currency)}</div><div class="date">${item.transaction_count} tx</div></div>`;
        } else {
            row.innerHTML = `<div><strong>${item.name}</strong><div class="muted">${item.most_common_category || '‚Äî'}</div></div><div class="right"><div class="amt">${fmtMoney(item.total_spent, data.base_currency)}</div><div class="date">${item.transaction_count} tx</div></div>`;
        }
        list.appendChild(row);
    });
}

// Dropdown controls
const toggleDropdown = (id, open) => {
    const el = q(id);
    el.classList.toggle('open', open);
    const btnId = id.replace('Dropdown', 'Btn');
    const menuId = id.replace('Dropdown', 'Menu');
    q(btnId).setAttribute('aria-expanded', el.classList.contains('open'));
    q(menuId).setAttribute('aria-hidden', !el.classList.contains('open'));
};

const setupDropdown = (btnId, dropId, searchId) => {
    q(btnId).onclick = (e) => { e.stopPropagation(); toggleDropdown(dropId); if(searchId) q(searchId).focus(); };
    if (searchId) q(searchId).onclick = e => e.stopPropagation();
};

setupDropdown('#navBtn', '#navDropdown');
setupDropdown('#excludeBtn', '#excludeDropdown', '#excludeSearch');
setupDropdown('#categoriesBtn', '#categoriesDropdown', '#categoriesSearch');

document.addEventListener('click', (e) => {
    ['#navDropdown', '#excludeDropdown', '#categoriesDropdown'].forEach(id => {
        if (!q(id).contains(e.target)) toggleDropdown(id, false);
    });
});

q('#btnRefresh').onclick = async () => { cacheClearAll(); init(); };
q('#btnUpdateRates').onclick = async () => { try { await fetch(`${API_BASE}/exchange-rates/update`, { method: 'POST' }); init(); alert('Rates updated'); } catch(e) { alert(e); }};

// Event bindings
q('#nwPeriod').onchange = loadNetworth;
q('#nwRange').onchange = loadNetworth;
q('#btnPrevMonth').onclick = () => { const s=q('#selectMonth'); if(s.selectedIndex<s.options.length-1) { s.selectedIndex++; s.dispatchEvent(new Event('change')); }};
q('#btnNextMonth').onclick = () => { const s=q('#selectMonth'); if(s.selectedIndex>0) { s.selectedIndex--; s.dispatchEvent(new Event('change')); }};
q('#selectMonth').onchange = (e) => loadMonthlyBreakdown(e.target.value);
q('#selectViewMode').onchange = () => loadMonthlyBreakdown(q('#selectMonth').value);
q('#selectYear').onchange = (e) => loadYearlySummary(e.target.value);
q('#catPeriod').onchange = loadCategoriesSeries;
q('#catRange').onchange = loadCategoriesSeries;
q('#payeeType').onchange = () => loadTopList('/dashboard/top-payees', 'topPayees');
q('#payeeRange').onchange = () => loadTopList('/dashboard/top-payees', 'topPayees');
q('#txType').onchange = () => loadTopList('/dashboard/top-individual-expenses', 'topTx', true);
q('#txRange').onchange = () => loadTopList('/dashboard/top-individual-expenses', 'topTx', true);
q('#excludeSearch').oninput = renderExcludeList;
q('#categoriesSearch').oninput = renderCategoriesList;
q('#excludeSelectAll').onclick = () => { state.accounts.forEach(a => state.excludedAccountIds.add(a.id)); renderExcludeList(); loadNetworth(); };
q('#excludeClear').onclick = () => { state.excludedAccountIds.clear(); renderExcludeList(); loadNetworth(); };
q('#categoriesSelectAll').onclick = () => { state.categories.forEach(c => state.selectedCategoryIds.add(c.id)); renderCategoriesList(); loadCategoriesSeries(); };
q('#categoriesClear').onclick = () => { state.selectedCategoryIds.clear(); renderCategoriesList(); loadCategoriesSeries(); };

// Initialisation
async function init() {
    try {
        await loadSummary();

        await Promise.all([
            loadAccounts(),
            loadNetworth(),
            loadAvailableMonths() 
        ]);

        await loadYearlyTrendAll();

        const years = [...new Set(state.months.map(m => m.year))].sort((a, b) => b - a);
        q('#selectYear').innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
        if (years.length) loadYearlySummary(years[0]);

        state.categories = await api('/categories');
        renderCategoriesList();
        
        loadTopList('/dashboard/top-payees', 'topPayees');
        loadTopList('/dashboard/top-individual-expenses', 'topTx', true);

    } catch (e) { console.error(e); }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>